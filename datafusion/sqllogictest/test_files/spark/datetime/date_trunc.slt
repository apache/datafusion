# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at

#   http://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

# YEAR - truncate to first date of year, time zeroed
query P
SELECT date_trunc('YEAR', '2015-03-05T09:32:05.123456'::timestamp);
----
2015-01-01T00:00:00

query P
SELECT date_trunc('YYYY', '2015-03-05T09:32:05.123456'::timestamp);
----
2015-01-01T00:00:00

query P
SELECT date_trunc('YY', '2015-03-05T09:32:05.123456'::timestamp);
----
2015-01-01T00:00:00

# QUARTER - truncate to first date of quarter, time zeroed
query P
SELECT date_trunc('QUARTER', '2015-05-05T09:32:05.123456'::timestamp);
----
2015-04-01T00:00:00

# MONTH - truncate to first date of month, time zeroed
query P
SELECT date_trunc('MONTH', '2015-03-05T09:32:05.123456'::timestamp);
----
2015-03-01T00:00:00

query P
SELECT date_trunc('MM', '2015-03-05T09:32:05.123456'::timestamp);
----
2015-03-01T00:00:00

query P
SELECT date_trunc('MON', '2015-03-05T09:32:05.123456'::timestamp);
----
2015-03-01T00:00:00

# WEEK - truncate to Monday of the week, time zeroed
query P
SELECT date_trunc('WEEK', '2015-03-05T09:32:05.123456'::timestamp);
----
2015-03-02T00:00:00

# DAY - zero out time part
query P
SELECT date_trunc('DAY', '2015-03-05T09:32:05.123456'::timestamp);
----
2015-03-05T00:00:00

query P
SELECT date_trunc('DD', '2015-03-05T09:32:05.123456'::timestamp);
----
2015-03-05T00:00:00

# HOUR - zero out minute and second with fraction
query P
SELECT date_trunc('HOUR', '2015-03-05T09:32:05.123456'::timestamp);
----
2015-03-05T09:00:00

# MINUTE - zero out second with fraction
query P
SELECT date_trunc('MINUTE', '2015-03-05T09:32:05.123456'::timestamp);
----
2015-03-05T09:32:00

# SECOND - zero out fraction
query P
SELECT date_trunc('SECOND', '2015-03-05T09:32:05.123456'::timestamp);
----
2015-03-05T09:32:05

# MILLISECOND - zero out microseconds
query P
SELECT date_trunc('MILLISECOND', '2015-03-05T09:32:05.123456'::timestamp);
----
2015-03-05T09:32:05.123

# MICROSECOND - everything remains
query P
SELECT date_trunc('MICROSECOND', '2015-03-05T09:32:05.123456'::timestamp);
----
2015-03-05T09:32:05.123456

query P
SELECT date_trunc('YEAR', column1)
FROM VALUES
('2015-03-05T09:32:05.123456'::timestamp),
('2020-11-15T22:45:30.654321'::timestamp),
('1999-07-20T14:20:10.000001'::timestamp),
(NULL::timestamp);
----
2015-01-01T00:00:00
2020-01-01T00:00:00
1999-01-01T00:00:00
NULL

# String input
query P
SELECT date_trunc('YEAR', '2015-03-05T09:32:05.123456');
----
2015-01-01T00:00:00

# Null handling
query error DataFusion error: Optimizer rule 'simplify_expressions' failed\ncaused by\nError during planning: First argument of `DATE_TRUNC` must be non-null scalar Utf8
SELECT date_trunc(NULL, '2015-03-05T09:32:05.123456');

query P
SELECT date_trunc('YEAR', NULL::timestamp);
----
NULL

# incorrect format
query error DataFusion error: Execution error: Unsupported date_trunc granularity: 'test'. Supported values are: microsecond, millisecond, second, minute, hour, day, week, month, quarter, year
SELECT date_trunc('test', '2015-03-05T09:32:05.123456');

# Timezone handling - Spark-compatible behavior
# Spark converts timestamps to session timezone before truncating for coarse granularities

query P
SELECT date_trunc('DAY', arrow_cast(timestamp '2024-07-15T03:30:00', 'Timestamp(Microsecond, Some("UTC"))'));
----
2024-07-15T00:00:00Z

query P
SELECT date_trunc('DAY', arrow_cast(timestamp '2024-07-15T03:30:00', 'Timestamp(Microsecond, None)'));
----
2024-07-15T00:00:00

statement ok
SET datafusion.execution.time_zone = 'America/New_York';

# This timestamp is 03:30 UTC = 23:30 EDT (previous day) on July 14
# With session timezone, truncation happens in America/New_York timezone
query P
SELECT date_trunc('DAY', arrow_cast(timestamp '2024-07-15T03:30:00', 'Timestamp(Microsecond, Some("UTC"))'));
----
2024-07-14T00:00:00Z

query P
SELECT date_trunc('DAY', arrow_cast(timestamp '2024-07-15T03:30:00', 'Timestamp(Microsecond, None)'));
----
2024-07-15T00:00:00

statement ok
RESET datafusion.execution.time_zone;
