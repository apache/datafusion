# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at

#   http://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

# set variable to value
statement ok
set datafusion.catalog.information_schema = true

statement ok
SET datafusion.execution.batch_size to 1

query TT
SHOW datafusion.execution.batch_size
----
datafusion.execution.batch_size 1

# set variable to value with equal sign

statement ok
set datafusion.catalog.information_schema = true

statement ok
SET datafusion.execution.batch_size = 1

query TT
SHOW datafusion.execution.batch_size
----
datafusion.execution.batch_size 1

# set variable to value with single quoted string
statement ok
set datafusion.catalog.information_schema = true

statement ok
SET datafusion.execution.batch_size to '1'

query TT
SHOW datafusion.execution.batch_size
----
datafusion.execution.batch_size 1

# set variable to value case insensitive
statement ok
set datafusion.catalog.information_schema = true

statement ok
SET datafusion.EXECUTION.batch_size to '1'

query TT
SHOW datafusion.execution.batch_size
----
datafusion.execution.batch_size 1

# set variable unknown variable
statement error DataFusion error: Invalid or Unsupported Configuration: could not find config namespace for key "aabbcc"
SET aabbcc to '1'

# set bool variable
statement ok
set datafusion.catalog.information_schema = true

statement ok
SET datafusion.execution.coalesce_batches to true

query TT
SHOW datafusion.execution.coalesce_batches
----
datafusion.execution.coalesce_batches true

statement ok
SET datafusion.execution.coalesce_batches to 'false'

query TT
SHOW datafusion.execution.coalesce_batches
----
datafusion.execution.coalesce_batches false

# set bool variable bad value

statement ok
set datafusion.catalog.information_schema = true

statement error DataFusion error: Error parsing '1' as bool
SET datafusion.execution.coalesce_batches to 1

statement error DataFusion error: Error parsing 'abc' as bool
SET datafusion.execution.coalesce_batches to abc

# set u64 variable
statement ok
set datafusion.catalog.information_schema = true

statement ok
SET datafusion.execution.batch_size to 0

query TT
SHOW datafusion.execution.batch_size
----
datafusion.execution.batch_size 0

statement ok
SET datafusion.execution.batch_size to '1'

query TT
SHOW datafusion.execution.batch_size
----
datafusion.execution.batch_size 1

statement ok
SET datafusion.execution.batch_size to +2

query TT
SHOW datafusion.execution.batch_size
----
datafusion.execution.batch_size 2

# set u64 variable bad value

statement ok
set datafusion.catalog.information_schema = true

statement error DataFusion error: Error parsing '-1' as usize
SET datafusion.execution.batch_size to -1

statement error DataFusion error: Error parsing 'abc' as usize
SET datafusion.execution.batch_size to abc

statement error External error: invalid digit found in string
SET datafusion.execution.batch_size to 0.1

# set time zone
statement ok
set datafusion.catalog.information_schema = true

statement ok
SET datafusion.execution.time_zone = '+08:00'

query TT
SHOW datafusion.execution.time_zone
----
datafusion.execution.time_zone +08:00

# set time zone with alias variable name
statement ok
set datafusion.catalog.information_schema = true

statement ok
SET TIME ZONE = '+08:00'

query TT
SHOW TIME ZONE
----
datafusion.execution.time_zone +08:00

statement ok
SET TIMEZONE = '+07:00'

query TT
SHOW TIMEZONE
----
datafusion.execution.time_zone +07:00

# set time zone good time zone format
statement ok
set datafusion.catalog.information_schema = true

statement ok
SET TIME ZONE = '+08:00'

query P
SELECT '2000-01-01T00:00:00'::TIMESTAMP::TIMESTAMPTZ
----
2000-01-01T00:00:00+08:00

statement ok
SET TIME ZONE = '-08:00'

query P
SELECT '2000-01-01T00:00:00'::TIMESTAMP::TIMESTAMPTZ
----
2000-01-01T00:00:00-08:00

statement ok
SET TIME ZONE = '+0800'

query P
SELECT '2000-01-01T00:00:00'::TIMESTAMP::TIMESTAMPTZ
----
2000-01-01T00:00:00+08:00

statement ok
SET TIME ZONE = '+08'

query P
SELECT '2000-01-01T00:00:00'::TIMESTAMP::TIMESTAMPTZ
----
2000-01-01T00:00:00+08:00

# set time zone bad time zone format
statement ok
set datafusion.catalog.information_schema = true

statement ok
SET TIME ZONE = '+08:00:00'

statement error Arrow error: Parser error: Invalid timezone "\+08:00:00": failed to parse timezone
SELECT '2000-01-01T00:00:00'::TIMESTAMP::TIMESTAMPTZ

statement ok
SET TIME ZONE = '08:00'

statement error Arrow error: Parser error: Invalid timezone "08:00": failed to parse timezone
SELECT '2000-01-01T00:00:00'::TIMESTAMP::TIMESTAMPTZ

statement ok
SET TIME ZONE = '08'

statement error Arrow error: Parser error: Invalid timezone "08": failed to parse timezone
SELECT '2000-01-01T00:00:00'::TIMESTAMP::TIMESTAMPTZ

statement ok
SET TIME ZONE = 'Asia/Taipei'

query P
SELECT '2000-01-01T00:00:00'::TIMESTAMP::TIMESTAMPTZ
----
2000-01-01T00:00:00+08:00

statement ok
SET TIME ZONE = 'Asia/Taipei2'

statement error Arrow error: Parser error: Invalid timezone "Asia/Taipei2": failed to parse timezone
SELECT '2000-01-01T00:00:00'::TIMESTAMP::TIMESTAMPTZ

# reset variable restores default
statement ok
set datafusion.catalog.information_schema = true

statement ok
SET datafusion.execution.batch_size = 1024

query TT
SHOW datafusion.execution.batch_size
----
datafusion.execution.batch_size 1024

statement ok
RESET datafusion.execution.batch_size

query TT
SHOW datafusion.execution.batch_size
----
datafusion.execution.batch_size 8192

# reset variable with NULL default
statement ok
set datafusion.catalog.information_schema = true

statement ok
SET datafusion.execution.parquet.max_predicate_cache_size = '123'

query TT
SHOW datafusion.execution.parquet.max_predicate_cache_size
----
datafusion.execution.parquet.max_predicate_cache_size 123

statement ok
RESET datafusion.execution.parquet.max_predicate_cache_size

query TT
SHOW datafusion.execution.parquet.max_predicate_cache_size
----
datafusion.execution.parquet.max_predicate_cache_size NULL

# reset time zone via aliases
statement ok
set datafusion.catalog.information_schema = true

statement ok
SET TIMEZONE = '-03:00'

statement ok
RESET TIMEZONE

query TT
SHOW TIMEZONE
----
datafusion.execution.time_zone NULL

statement ok
SET TIME ZONE = '+09:00'

statement ok
RESET timezone

query TT
SHOW TIME ZONE
----
datafusion.execution.time_zone NULL

# reset runtime variables
statement ok
SET datafusion.runtime.memory_limit = '1M'

statement ok
RESET datafusion.runtime.memory_limit

statement ok
SET datafusion.runtime.max_temp_directory_size = '1M'

statement ok
RESET datafusion.runtime.max_temp_directory_size

statement ok
SET datafusion.runtime.metadata_cache_limit = '1M'

statement ok
RESET datafusion.runtime.metadata_cache_limit

statement ok
SET datafusion.runtime.temp_directory = './'

statement ok
RESET datafusion.runtime.temp_directory

# test memory limit effect
statement ok
SET datafusion.runtime.memory_limit = '1K'

# This query should fail with low memory
statement error Not enough memory to continue external sort
EXPLAIN ANALYZE SELECT * FROM generate_series(1, 1000) AS t1(v1) ORDER BY v1

statement ok
RESET datafusion.runtime.memory_limit

# This query should succeed after resetting memory limit
statement ok
EXPLAIN ANALYZE SELECT * FROM generate_series(1, 1000) AS t1(v1) ORDER BY v1

statement ok
SET datafusion.runtime.list_files_cache_limit = '1K'

statement ok
RESET datafusion.runtime.list_files_cache_limit

statement ok
SET datafusion.runtime.list_files_cache_ttl = '1m'

statement ok
RESET datafusion.runtime.list_files_cache_ttl

# reset invalid variable - typo in namespace
statement error DataFusion error: Invalid or Unsupported Configuration: Could not find config namespace "dataexplosion"
RESET dataexplosion.execution.batch_size

# reset invalid variable - wrong namespace prefix
statement error DataFusion error: Invalid or Unsupported Configuration: Config value "exec" not found on ConfigOptions
RESET datafusion.exec.batch_size

# reset invalid variable - typo in field name
statement error DataFusion error: Invalid or Unsupported Configuration: Config value "batches_size" not found on ExecutionOptions
RESET datafusion.execution.batches_size

# reset invalid variable - extra suffix on valid field
statement error DataFusion error: Invalid or Unsupported Configuration: Config field is a scalar usize and does not have nested field "bar"
RESET datafusion.execution.batch_size.bar

############
## Test runtime configuration variables
############

# Test SHOW runtime.memory_limit (default value)
query TT
SHOW datafusion.runtime.memory_limit
----
datafusion.runtime.memory_limit unlimited

# Test SET and SHOW runtime.memory_limit
statement ok
SET datafusion.runtime.memory_limit = '100M'

query TT
SHOW datafusion.runtime.memory_limit
----
datafusion.runtime.memory_limit 100M

# Test SET and SHOW runtime.max_temp_directory_size
statement ok
SET datafusion.runtime.max_temp_directory_size = '10G'

query TT
SHOW datafusion.runtime.max_temp_directory_size
----
datafusion.runtime.max_temp_directory_size 10G

# Test SET and SHOW runtime.metadata_cache_limit
statement ok
SET datafusion.runtime.metadata_cache_limit = '200M'

query TT
SHOW datafusion.runtime.metadata_cache_limit
----
datafusion.runtime.metadata_cache_limit 200M

# Test SET and SHOW runtime.list_files_cache_limit
statement ok
SET datafusion.runtime.list_files_cache_limit = '2M'

query TT
SHOW datafusion.runtime.list_files_cache_limit
----
datafusion.runtime.list_files_cache_limit 2M

# Test SET and SHOW runtime.list_files_cache_ttl
statement ok
SET datafusion.runtime.list_files_cache_ttl = '90s'

query TT
SHOW datafusion.runtime.list_files_cache_ttl
----
datafusion.runtime.list_files_cache_ttl 1m30s

# Note: runtime.temp_directory shows the actual temp directory path with a unique suffix,
# so we cannot test the exact value. We verify it exists in information_schema instead.

# Test that all runtime variables appear in information_schema.df_settings
query T
SELECT name FROM information_schema.df_settings WHERE name LIKE 'datafusion.runtime.%' ORDER BY name
----
datafusion.runtime.list_files_cache_limit
datafusion.runtime.list_files_cache_ttl
datafusion.runtime.max_temp_directory_size
datafusion.runtime.memory_limit
datafusion.runtime.metadata_cache_limit
datafusion.runtime.temp_directory
