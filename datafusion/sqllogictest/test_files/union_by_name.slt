# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at

#   http://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

statement ok
CREATE TABLE t1 (x INT, y INT);

statement ok
INSERT INTO t1 VALUES (3, 3), (3, 3), (1, 1);

statement ok
CREATE TABLE t2 (y INT, z INT);

statement ok
INSERT INTO t2 VALUES (2, 2), (4, 4);


# Test binding
query I
SELECT t1.x FROM t1 UNION BY NAME SELECT x FROM t1 ORDER BY t1.x;
----
1
3

query I
SELECT t1.x FROM t1 UNION ALL BY NAME SELECT x FROM t1 ORDER BY t1.x;
----
1
1
3
3
3
3

query I
SELECT x FROM t1 UNION BY NAME SELECT x FROM t1 ORDER BY t1.x;
----
1
3

query I
SELECT x FROM t1 UNION ALL BY NAME SELECT x FROM t1 ORDER BY t1.x;
----
1
1
3
3
3
3

query II
(SELECT x FROM t1 UNION ALL SELECT x FROM t1) UNION BY NAME SELECT 5 ORDER BY x;
----
NULL 1
NULL 3
5 NULL

# TODO: This should pass, but the sanity checker isn't allowing it.
# Commenting out the ordering check in the sanity checker produces the correct result.
query error
(SELECT x FROM t1 UNION ALL SELECT x FROM t1) UNION ALL BY NAME SELECT 5 ORDER BY x;
----
DataFusion error: SanityCheckPlan
caused by
Error during planning: Plan: ["SortPreservingMergeExec: [x@1 ASC NULLS LAST]", "  UnionExec", "    SortExec: expr=[x@1 ASC NULLS LAST], preserve_partitioning=[true]", "      ProjectionExec: expr=[NULL as Int64(5), x@0 as x]", "        UnionExec", "          MemoryExec: partitions=1, partition_sizes=[1]", "          MemoryExec: partitions=1, partition_sizes=[1]", "    ProjectionExec: expr=[5 as Int64(5), NULL as x]", "      PlaceholderRowExec"] does not satisfy order requirements: [x@1 ASC NULLS LAST]. Child-0 order: []


query II
(SELECT x FROM t1 UNION ALL SELECT y FROM t1) UNION BY NAME SELECT 5 ORDER BY x;
----
NULL 1
NULL 3
5 NULL

# TODO: This should pass, but the sanity checker isn't allowing it.
# Commenting out the ordering check in the sanity checker produces the correct result.
query error
(SELECT x FROM t1 UNION ALL SELECT y FROM t1) UNION ALL BY NAME SELECT 5 ORDER BY x;
----
DataFusion error: SanityCheckPlan
caused by
Error during planning: Plan: ["SortPreservingMergeExec: [x@1 ASC NULLS LAST]", "  UnionExec", "    SortExec: expr=[x@1 ASC NULLS LAST], preserve_partitioning=[true]", "      ProjectionExec: expr=[NULL as Int64(5), x@0 as x]", "        UnionExec", "          MemoryExec: partitions=1, partition_sizes=[1]", "          ProjectionExec: expr=[y@0 as x]", "            MemoryExec: partitions=1, partition_sizes=[1]", "    ProjectionExec: expr=[5 as Int64(5), NULL as x]", "      PlaceholderRowExec"] does not satisfy order requirements: [x@1 ASC NULLS LAST]. Child-0 order: []



# Ambiguous name

statement error DataFusion error: Schema error: No field named t1.x. Valid fields are a, b.
SELECT x AS a FROM t1 UNION BY NAME SELECT x AS b FROM t1 ORDER BY t1.x;

query II
(SELECT y FROM t1 UNION ALL SELECT x FROM t1) UNION BY NAME (SELECT z FROM t2 UNION ALL SELECT y FROM t2) ORDER BY y, z;
----
1 NULL
3 NULL
NULL 2
NULL 4

# Limit

query III rowsort
SELECT 1 UNION BY NAME SELECT * FROM unnest(range(2, 100)) UNION BY NAME SELECT 999 ORDER BY "Int64(999)", "Int64(1)" LIMIT 5;
----
1 NULL NULL
NULL 999 NULL
NULL NULL 13
NULL NULL 20
NULL NULL 4

# Order by

query III
SELECT x, y FROM t1 UNION BY NAME SELECT y, z FROM t2 ORDER BY y;
----
1 1 NULL
NULL 2 2
3 3 NULL
NULL 4 4

query III
SELECT x, y FROM t1 UNION BY NAME SELECT y, z FROM t2 ORDER BY 3, 1;
----
NULL 2 2
NULL 4 4
1 1 NULL
3 3 NULL

statement error
SELECT x, y FROM t1 UNION BY NAME SELECT y, z FROM t2 ORDER BY 4;
----
DataFusion error: Error during planning: Order by column out of bounds, specified: 4, max: 3


# Multi set operations

query IIII rowsort
(SELECT 1 UNION BY NAME SELECT x, y FROM t1) UNION BY NAME SELECT y, z FROM t2;
----
1 NULL NULL NULL
NULL 1 1 NULL
NULL 3 3 NULL
NULL NULL 2 2
NULL NULL 4 4

query III
SELECT x, y FROM t1 UNION BY NAME (SELECT y, z FROM t2 INTERSECT SELECT 2, 2 as two FROM t1 ORDER BY 1) ORDER BY 1;
----
1 1 NULL
3 3 NULL
NULL 2 2


query III
(SELECT x, y FROM t1 UNION BY NAME SELECT y, z FROM t2 ORDER BY 1) EXCEPT SELECT NULL, 2, 2 as two FROM t1 ORDER BY 1;
----
1 1 NULL
3 3 NULL
NULL 4 4


# Alias in select list

query II
SELECT x as a FROM t1 UNION BY NAME SELECT x FROM t1 ORDER BY 1, 2;
----
1 NULL
3 NULL
NULL 1
NULL 3

# Different types

query T rowsort
select '0' as c union all by name select 0 as c;
----
0
0
