# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

# Import common test data
include ../init_data.slt.part

# =====================================================================
# Exclusion Pattern Tests
# =====================================================================

# Test 1: Basic exclusion pattern A {- B -}
query TDI
SELECT * FROM stock_price
MATCH_RECOGNIZE (
    PARTITION BY company
    ORDER BY price_date
    ALL ROWS PER MATCH
    PATTERN (A ({- B -}))
    DEFINE
        A AS price < 130,
        B AS price > 130
)
----
DDOG 2024-01-02 128
DDOG 2024-01-04 129

# Test 2: Pattern with only an excluded symbol {- B -} should emit no rows
query TDI
SELECT * FROM stock_price
MATCH_RECOGNIZE (
    PARTITION BY company
    ORDER BY price_date
    ALL ROWS PER MATCH
    PATTERN ({- B -}+)
    DEFINE
        B AS price > 140
)
----


query TIII
SELECT * FROM stock_price
MATCH_RECOGNIZE (
    PARTITION BY company
    ORDER BY price_date
    MEASURES
        FIRST(B.price) AS first_price,
        LAST(B.price) AS last_price,
        COUNT(*) AS count
    ONE ROW PER MATCH
    PATTERN (ANY ({- B -}+) ANY)
    DEFINE
        B AS price > 140
)
ORDER BY company
----
AAPL 187 197 10
AMZN 152 162 10
CRM 248 263 10
DDOG 141 141 3
GOOGL 142 152 10
META 338 353 10
MSFT 378 393 10
NFLX 488 503 10
NVDA 492 518 10
TSLA 251 266 10


query TDIIIIII
SELECT * FROM stock_price
MATCH_RECOGNIZE (
    PARTITION BY company
    ORDER BY price_date
    MEASURES
        FIRST(B.price) AS first_price,
        LAST(B.price) AS last_price,
        COUNT(*) AS count,
        MATCH_NUMBER() AS match_number,
        MATCH_SEQUENCE_NUMBER() AS match_sequence_number
    ALL ROWS PER MATCH
    PATTERN (ANY ({- B -}+) ANY)
    DEFINE
        B AS price > 140
)
ORDER BY company
----
AAPL 2024-01-01 185 NULL NULL 1 1 1
AAPL 2024-01-12 199 187 197 10 1 10
AMZN 2024-01-01 150 NULL NULL 1 1 1
AMZN 2024-01-12 164 152 162 10 1 10
CRM 2024-01-01 245 NULL NULL 1 1 1
CRM 2024-01-12 266 248 263 10 1 10
DDOG 2024-01-08 138 NULL NULL 1 1 1
DDOG 2024-01-10 139 141 141 3 1 3
GOOGL 2024-01-01 140 NULL NULL 1 1 1
GOOGL 2024-01-12 154 142 152 10 1 10
META 2024-01-01 335 NULL NULL 1 1 1
META 2024-01-12 356 338 353 10 1 10
MSFT 2024-01-01 375 NULL NULL 1 1 1
MSFT 2024-01-12 396 378 393 10 1 10
NFLX 2024-01-01 485 NULL NULL 1 1 1
NFLX 2024-01-12 506 488 503 10 1 10
NVDA 2024-01-01 485 NULL NULL 1 1 1
NVDA 2024-01-12 525 492 518 10 1 10
TSLA 2024-01-01 248 NULL NULL 1 1 1
TSLA 2024-01-12 269 251 266 10 1 10

# Test 4: Pattern A {- A -} A (emit first A, exclude second consecutive A, emit third A)
query TDI
SELECT * FROM stock_price
MATCH_RECOGNIZE (
    PARTITION BY company
    ORDER BY price_date
    ALL ROWS PER MATCH
    PATTERN (A ({- A -}) A)
    DEFINE
        A AS price < 135
)
----
DDOG 2024-01-01 125
DDOG 2024-01-03 132
