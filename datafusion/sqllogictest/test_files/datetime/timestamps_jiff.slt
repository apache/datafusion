# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at

#   http://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

statement ok
SET datafusion.execution.date_time_parser = 'jiff';

statement ok
create table ts_data(ts bigint, value int) as values
  (1599572549190855123, 1),
  (1599568949190855123, 2),
  (1599565349190855123, 3);

statement ok
create table ts_data_nanos as select arrow_cast(ts, 'Timestamp(Nanosecond, None)') as ts, value from ts_data;

statement ok
create table ts_data_micros as select arrow_cast(ts / 1000, 'Timestamp(Microsecond, None)') as ts, value from ts_data;

statement ok
create table ts_data_millis as select arrow_cast(ts / 1000000, 'Timestamp(Millisecond, None)') as ts, value from ts_data;

statement ok
create table ts_data_secs as select arrow_cast(ts / 1000000000, 'Timestamp(Second, None)') as ts, value from ts_data;

# verify chrono formats don't work

query error strptime parsing failed
SELECT COUNT(*) FROM ts_data_nanos where ts > to_timestamp('2020-09-08T12:00:00+00:00', '%Y-%m-%dT%H:%M:%S%Z')

# to_timestamp with formatting
query I
SELECT COUNT(*) FROM ts_data_nanos where ts > to_timestamp('2020-09-08T12:00:00+00:00', '2020-09-08 12/00/00+00:00', '%+', '%Y-%m-%d %H/%M/%s%#z')
----
2

# to_timestamp_nanos with formatting
query I
SELECT COUNT(*) FROM ts_data_nanos where ts > to_timestamp_nanos('2020-09-08 12/00/00+00:00', '%c', '%+', '%Y-%m-%d %H/%M/%S%#:z')
----
2

# to_timestamp_millis with formatting
query I
SELECT COUNT(*) FROM ts_data_millis where ts > to_timestamp_millis('2020-09-08 12/00/00+00:00', '%c', '%+', '%Y-%m-%d %H/%M/%S%#:z')
----
2

# to_timestamp_micros with formatting
query I
SELECT COUNT(*) FROM ts_data_micros where ts > to_timestamp_micros('2020-09-08 12/00/00+00:00', '%c', '%+', '%Y-%m-%d %H/%M/%S%#:z')
----
2

# to_timestamp_seconds with formatting
query I
SELECT COUNT(*) FROM ts_data_secs where ts > to_timestamp_seconds('2020-09-08 12/00/00+00:00', '%c', '%+', '%Y-%m-%d %H/%M/%S%#:z')
----
2

# verify timestamp data with formatting options
query PPPPPP
SELECT to_timestamp(null, '%+'), to_timestamp(0, '%s'), to_timestamp(1926632005, '%s'), to_timestamp(1, '%+', '%s'), to_timestamp(-1, '%c', '%+', '%s'), to_timestamp(0-1, '%c', '%+', '%s')
----
NULL 1970-01-01T00:00:00 2031-01-19T23:33:25 1970-01-01T00:00:01 1969-12-31T23:59:59 1969-12-31T23:59:59

# verify timestamp data with formatting options
query PPPPPP
SELECT to_timestamp(null, '%+'), to_timestamp(0, '%s'), to_timestamp(1926632005, '%s'), to_timestamp(1, '%+', '%s'), to_timestamp(-1, '%c', '%+', '%s'), to_timestamp(0-1, '%c', '%+', '%s')
----
NULL 1970-01-01T00:00:00 2031-01-19T23:33:25 1970-01-01T00:00:01 1969-12-31T23:59:59 1969-12-31T23:59:59

# verify timestamp output types with formatting options
query TTT
SELECT arrow_typeof(to_timestamp(1, '%c', '%s')), arrow_typeof(to_timestamp(null, '%+', '%s')), arrow_typeof(to_timestamp('2023-01-10 12:34:56.000', '%Y-%m-%d %H:%M:%S%.f'))
----
Timestamp(ns) Timestamp(ns) Timestamp(ns)

# to_timestamp with invalid formatting
query error strptime parsing failed: expected to match literal byte `T` from format string, but found byte ` ` in input
SELECT to_timestamp('2020-09-08 12/00/00+00:00', '%c', '%+')

# to_timestamp_nanos with invalid formatting
query error strptime parsing failed: expected to match literal byte `T` from format string, but found byte ` ` in input
SELECT to_timestamp_nanos('2020-09-08 12/00/00+00:00', '%c', '%+')

# to_timestamp_millis with invalid formatting
query error strptime parsing failed: expected to match literal byte `T` from format string, but found byte ` ` in input
SELECT to_timestamp_millis('2020-09-08 12/00/00+00:00', '%c', '%+')

# to_timestamp_micros with invalid formatting
query error strptime parsing failed: expected to match literal byte `T` from format string, but found byte ` ` in input
SELECT to_timestamp_micros('2020-09-08 12/00/00+00:00', '%c', '%+')

# to_timestamp_seconds with invalid formatting
query error strptime parsing failed: expected to match literal byte `T` from format string, but found byte ` ` in input
SELECT to_timestamp_seconds('2020-09-08 12/00/00+00:00', '%c', '%+')

# to_timestamp with broken formatting
query error DataFusion error: Execution error: Error parsing timestamp from '2020\-09\-08 12/00/00\+00:00' using formats: \["%q"\]: 
SELECT to_timestamp('2020-09-08 12/00/00+00:00', '%q')

# to_timestamp_nanos with broken formatting
query error DataFusion error: Execution error: Error parsing timestamp from '2020\-09\-08 12/00/00\+00:00' using formats: \["%q"\]: 
SELECT to_timestamp_nanos('2020-09-08 12/00/00+00:00', '%q')

# to_timestamp_millis with broken formatting
query error DataFusion error: Execution error: Error parsing timestamp from '2020\-09\-08 12/00/00\+00:00' using formats: \["%q"\]: 
SELECT to_timestamp_millis('2020-09-08 12/00/00+00:00', '%q')

# to_timestamp_micros with broken formatting
query error DataFusion error: Execution error: Error parsing timestamp from '2020\-09\-08 12/00/00\+00:00' using formats: \["%q"\]: 
SELECT to_timestamp_micros('2020-09-08 12/00/00+00:00', '%q')

# to_timestamp_seconds with broken formatting
query error DataFusion error: Execution error: Error parsing timestamp from '2020\-09\-08 12/00/00\+00:00' using formats: \["%q"\]: 
SELECT to_timestamp_seconds('2020-09-08 12/00/00+00:00', '%q')

# Create string timestamp table with different formats
# including a few very non-standard formats

statement ok
create table ts_utf8_data(ts varchar(100), format varchar(100)) as values
  ('2020-09-08 12/00/00+00:00', '%Y-%m-%d %H/%M/%S%#:z'),
  ('2031-01-19T23:33:25+05:00', '%+'),
  ('08-09-2020 12:00:00+00:00', '%d-%m-%Y %H:%M:%S%#:z'),
  ('1926632005', '%s'),
  ('2000-01-01T01:01:01+07:00', '%+');

statement ok
create table ts_largeutf8_data as
select arrow_cast(ts, 'LargeUtf8') as ts, arrow_cast(format, 'LargeUtf8') as format from ts_utf8_data;

statement ok
create table ts_utf8view_data as
select arrow_cast(ts, 'Utf8View') as ts, arrow_cast(format, 'Utf8View') as format from ts_utf8_data;

# verify timestamp data using tables with formatting options
query P
SELECT to_timestamp(t.ts, t.format) from ts_utf8_data as t
----
2020-09-08T12:00:00
2031-01-19T18:33:25
2020-09-08T12:00:00
2031-01-19T23:33:25
1999-12-31T18:01:01

query PPPPP
SELECT to_timestamp(t.ts, t.format),
       to_timestamp_seconds(t.ts, t.format),
       to_timestamp_millis(t.ts, t.format),
       to_timestamp_micros(t.ts, t.format),
       to_timestamp_nanos(t.ts, t.format)
       from ts_largeutf8_data as t
----
2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00
2031-01-19T18:33:25 2031-01-19T18:33:25 2031-01-19T18:33:25 2031-01-19T18:33:25 2031-01-19T18:33:25
2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00
2031-01-19T23:33:25 2031-01-19T23:33:25 2031-01-19T23:33:25 2031-01-19T23:33:25 2031-01-19T23:33:25
1999-12-31T18:01:01 1999-12-31T18:01:01 1999-12-31T18:01:01 1999-12-31T18:01:01 1999-12-31T18:01:01

query PPPPP
SELECT to_timestamp(t.ts, t.format),
       to_timestamp_seconds(t.ts, t.format),
       to_timestamp_millis(t.ts, t.format),
       to_timestamp_micros(t.ts, t.format),
       to_timestamp_nanos(t.ts, t.format)
       from ts_utf8view_data as t
----
2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00
2031-01-19T18:33:25 2031-01-19T18:33:25 2031-01-19T18:33:25 2031-01-19T18:33:25 2031-01-19T18:33:25
2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00
2031-01-19T23:33:25 2031-01-19T23:33:25 2031-01-19T23:33:25 2031-01-19T23:33:25 2031-01-19T23:33:25
1999-12-31T18:01:01 1999-12-31T18:01:01 1999-12-31T18:01:01 1999-12-31T18:01:01 1999-12-31T18:01:01

# verify timestamp data using tables with formatting options
query PPPPP
SELECT to_timestamp(t.ts, '%Y-%m-%d %H/%M/%S%#:z', '%+', '%s', '%d-%m-%Y %H:%M:%S%#:z'),
       to_timestamp_seconds(t.ts, '%Y-%m-%d %H/%M/%S%#:z', '%+', '%s', '%d-%m-%Y %H:%M:%S%#:z'),
       to_timestamp_millis(t.ts, '%Y-%m-%d %H/%M/%S%#:z', '%+', '%s', '%d-%m-%Y %H:%M:%S%#:z'),
       to_timestamp_micros(t.ts, '%Y-%m-%d %H/%M/%S%#:z', '%+', '%s', '%d-%m-%Y %H:%M:%S%#:z'),
       to_timestamp_nanos(t.ts, '%Y-%m-%d %H/%M/%S%#:z', '%+', '%s', '%d-%m-%Y %H:%M:%S%#:z')
       from ts_utf8_data as t
----
2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00
2031-01-19T18:33:25 2031-01-19T18:33:25 2031-01-19T18:33:25 2031-01-19T18:33:25 2031-01-19T18:33:25
2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00
2031-01-19T23:33:25 2031-01-19T23:33:25 2031-01-19T23:33:25 2031-01-19T23:33:25 2031-01-19T23:33:25
1999-12-31T18:01:01 1999-12-31T18:01:01 1999-12-31T18:01:01 1999-12-31T18:01:01 1999-12-31T18:01:01

query PPPPP
SELECT to_timestamp(t.ts, '%Y-%m-%d %H/%M/%S%#:z', '%+', '%s', '%d-%m-%Y %H:%M:%S%#:z'),
       to_timestamp_seconds(t.ts, '%Y-%m-%d %H/%M/%S%#:z', '%+', '%s', '%d-%m-%Y %H:%M:%S%#:z'),
       to_timestamp_millis(t.ts, '%Y-%m-%d %H/%M/%S%#:z', '%+', '%s', '%d-%m-%Y %H:%M:%S%#:z'),
       to_timestamp_micros(t.ts, '%Y-%m-%d %H/%M/%S%#:z', '%+', '%s', '%d-%m-%Y %H:%M:%S%#:z'),
       to_timestamp_nanos(t.ts, '%Y-%m-%d %H/%M/%S%#:z', '%+', '%s', '%d-%m-%Y %H:%M:%S%#:z')
       from ts_largeutf8_data as t
----
2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00
2031-01-19T18:33:25 2031-01-19T18:33:25 2031-01-19T18:33:25 2031-01-19T18:33:25 2031-01-19T18:33:25
2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00
2031-01-19T23:33:25 2031-01-19T23:33:25 2031-01-19T23:33:25 2031-01-19T23:33:25 2031-01-19T23:33:25
1999-12-31T18:01:01 1999-12-31T18:01:01 1999-12-31T18:01:01 1999-12-31T18:01:01 1999-12-31T18:01:01

query PPPPP
SELECT to_timestamp(t.ts, '%Y-%m-%d %H/%M/%S%#:z', '%+', '%s', '%d-%m-%Y %H:%M:%S%#:z'),
       to_timestamp_seconds(t.ts, '%Y-%m-%d %H/%M/%S%#:z', '%+', '%s', '%d-%m-%Y %H:%M:%S%#:z'),
       to_timestamp_millis(t.ts, '%Y-%m-%d %H/%M/%S%#:z', '%+', '%s', '%d-%m-%Y %H:%M:%S%#:z'),
       to_timestamp_micros(t.ts, '%Y-%m-%d %H/%M/%S%#:z', '%+', '%s', '%d-%m-%Y %H:%M:%S%#:z'),
       to_timestamp_nanos(t.ts, '%Y-%m-%d %H/%M/%S%#:z', '%+', '%s', '%d-%m-%Y %H:%M:%S%#:z')
       from ts_utf8view_data as t
----
2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00
2031-01-19T18:33:25 2031-01-19T18:33:25 2031-01-19T18:33:25 2031-01-19T18:33:25 2031-01-19T18:33:25
2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00 2020-09-08T12:00:00
2031-01-19T23:33:25 2031-01-19T23:33:25 2031-01-19T23:33:25 2031-01-19T23:33:25 2031-01-19T23:33:25
1999-12-31T18:01:01 1999-12-31T18:01:01 1999-12-31T18:01:01 1999-12-31T18:01:01 1999-12-31T18:01:01

# verify timestamp data using tables with formatting options where at least one column cannot be parsed
query error
SELECT to_timestamp(t.ts, '%Y-%m-%d %H/%M/%S%#z', '%+', '%d-%m-%Y %H:%M:%S%#:z') from ts_utf8_data as t
----
DataFusion error: Execution error: Error parsing timestamp from '2020-09-08 12/00/00+00:00' using formats: ["%Y-%m-%d %H/%M/%S%#z", "%+", "%d-%m-%Y %H:%M:%S%#:z"]: strptime parsing failed: expected to match literal byte `-` from format string, but found byte `2` in input


# verify timestamp data using tables with formatting options where one of the formats is invalid
query P
SELECT to_timestamp(t.ts, '%Y-%m-%d %H/%M/%S%#:z', '%s', '%q', '%d-%m-%Y %H:%M:%S%#:z', '%+') from ts_utf8_data as t
----
2020-09-08T12:00:00
2031-01-19T18:33:25
2020-09-08T12:00:00
2031-01-19T23:33:25
1999-12-31T18:01:01

query P
SELECT to_timestamp(t.ts, '%Y-%m-%d %H/%M/%S%#:z', '%s', '%q', '%d-%m-%Y %H:%M:%S%#:z', '%+') from ts_largeutf8_data as t
----
2020-09-08T12:00:00
2031-01-19T18:33:25
2020-09-08T12:00:00
2031-01-19T23:33:25
1999-12-31T18:01:01

query P
SELECT to_timestamp(t.ts, '%Y-%m-%d %H/%M/%S%#:z', '%s', '%q', '%d-%m-%Y %H:%M:%S%#:z', '%+') from ts_utf8view_data as t
----
2020-09-08T12:00:00
2031-01-19T18:33:25
2020-09-08T12:00:00
2031-01-19T23:33:25
1999-12-31T18:01:01

# timestamp data using tables with formatting options in an array is not supported at this time
query error function unsupported data type at index 1:
SELECT to_timestamp(t.ts, make_array('%Y-%m-%d %H/%M/%S%#:z', '%s', '%q', '%d-%m-%Y %H:%M:%S%#:z', '%+')) from ts_utf8_data as t

statement ok
drop table ts_utf8_data

statement ok
drop table ts_data

statement ok
drop table ts_data_nanos

statement ok
drop table ts_data_micros

statement ok
drop table ts_data_millis

statement ok
drop table ts_data_secs

statement ok
SET datafusion.execution.date_time_parser = 'chrono';
