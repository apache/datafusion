# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at

#   http://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

# Tests for `date_part` and `EXTRACT` (which is a different syntax
# for the same function).


## Begin tests for date_part with columns and timestamp's with timezones

# Source data table has
# timestamps with millisecond (very common timestamp precision) and nanosecond (maximum precision) timestamps
statement count 0
CREATE TABLE source_ts AS
with t as (values
  ('2020-01-01T00:00:00+00:00'),
  ('2021-01-01T00:00:00+00:00'),           -- year
  ('2020-09-01T00:00:00+00:00'),           -- month
  ('2020-01-25T00:00:00+00:00'),           -- day
  ('2020-01-24T00:00:00+00:00'),           -- day
  ('2020-01-01T12:00:00+00:00'),           -- hour
  ('2020-01-01T00:30:00+00:00'),           -- minute
  ('2020-01-01T00:00:30+00:00'),           -- second
  ('2020-01-01T00:00:00.123+00:00'),       -- ms
  ('2020-01-01T00:00:00.123456+00:00'),    -- us
  ('2020-01-01T00:00:00.123456789+00:00')  -- ns
)
SELECT
  -- nanoseconds, with no, utc, and local timezone
  arrow_cast(column1, 'Timestamp(ns)') as ts_nano_no_tz,
  arrow_cast(column1, 'Timestamp(Nanosecond, None)') as ts_nano_no_tz_old_format,
  arrow_cast(column1, 'Timestamp(Nanosecond, Some("UTC"))') as ts_nano_utc,
  arrow_cast(column1, 'Timestamp(Nanosecond, Some("America/New_York"))') as ts_nano_eastern,
  -- milliseconds, with no, utc, and local timezone
  arrow_cast(column1, 'Timestamp(ms)') as ts_milli_no_tz,
  arrow_cast(column1, 'Timestamp(Millisecond, None)') as ts_milli_no_tz_old_format,
  arrow_cast(column1, 'Timestamp(Millisecond, Some("UTC"))') as ts_milli_utc,
  arrow_cast(column1, 'Timestamp(Millisecond, Some("America/New_York"))') as ts_milli_eastern
FROM t;


query PPPPPPPP
SELECT * FROM source_ts;
----
2020-01-01T00:00:00 2020-01-01T00:00:00 2020-01-01T00:00:00Z 2019-12-31T19:00:00-05:00 2020-01-01T00:00:00 2020-01-01T00:00:00 2020-01-01T00:00:00Z 2019-12-31T19:00:00-05:00
2021-01-01T00:00:00 2021-01-01T00:00:00 2021-01-01T00:00:00Z 2020-12-31T19:00:00-05:00 2021-01-01T00:00:00 2021-01-01T00:00:00 2021-01-01T00:00:00Z 2020-12-31T19:00:00-05:00
2020-09-01T00:00:00 2020-09-01T00:00:00 2020-09-01T00:00:00Z 2020-08-31T20:00:00-04:00 2020-09-01T00:00:00 2020-09-01T00:00:00 2020-09-01T00:00:00Z 2020-08-31T20:00:00-04:00
2020-01-25T00:00:00 2020-01-25T00:00:00 2020-01-25T00:00:00Z 2020-01-24T19:00:00-05:00 2020-01-25T00:00:00 2020-01-25T00:00:00 2020-01-25T00:00:00Z 2020-01-24T19:00:00-05:00
2020-01-24T00:00:00 2020-01-24T00:00:00 2020-01-24T00:00:00Z 2020-01-23T19:00:00-05:00 2020-01-24T00:00:00 2020-01-24T00:00:00 2020-01-24T00:00:00Z 2020-01-23T19:00:00-05:00
2020-01-01T12:00:00 2020-01-01T12:00:00 2020-01-01T12:00:00Z 2020-01-01T07:00:00-05:00 2020-01-01T12:00:00 2020-01-01T12:00:00 2020-01-01T12:00:00Z 2020-01-01T07:00:00-05:00
2020-01-01T00:30:00 2020-01-01T00:30:00 2020-01-01T00:30:00Z 2019-12-31T19:30:00-05:00 2020-01-01T00:30:00 2020-01-01T00:30:00 2020-01-01T00:30:00Z 2019-12-31T19:30:00-05:00
2020-01-01T00:00:30 2020-01-01T00:00:30 2020-01-01T00:00:30Z 2019-12-31T19:00:30-05:00 2020-01-01T00:00:30 2020-01-01T00:00:30 2020-01-01T00:00:30Z 2019-12-31T19:00:30-05:00
2020-01-01T00:00:00.123 2020-01-01T00:00:00.123 2020-01-01T00:00:00.123Z 2019-12-31T19:00:00.123-05:00 2020-01-01T00:00:00.123 2020-01-01T00:00:00.123 2020-01-01T00:00:00.123Z 2019-12-31T19:00:00.123-05:00
2020-01-01T00:00:00.123456 2020-01-01T00:00:00.123456 2020-01-01T00:00:00.123456Z 2019-12-31T19:00:00.123456-05:00 2020-01-01T00:00:00.123 2020-01-01T00:00:00.123 2020-01-01T00:00:00.123Z 2019-12-31T19:00:00.123-05:00
2020-01-01T00:00:00.123456789 2020-01-01T00:00:00.123456789 2020-01-01T00:00:00.123456789Z 2019-12-31T19:00:00.123456789-05:00 2020-01-01T00:00:00.123 2020-01-01T00:00:00.123 2020-01-01T00:00:00.123Z 2019-12-31T19:00:00.123-05:00

# date_part (year) with columns and explicit timestamp
query IIIIII
SELECT date_part('year', ts_nano_no_tz), date_part('year', ts_nano_utc), date_part('year', ts_nano_eastern), date_part('year', ts_milli_no_tz), date_part('year', ts_milli_utc), date_part('year', ts_milli_eastern)  FROM source_ts;
----
2020 2020 2019 2020 2020 2019
2021 2021 2020 2021 2021 2020
2020 2020 2020 2020 2020 2020
2020 2020 2020 2020 2020 2020
2020 2020 2020 2020 2020 2020
2020 2020 2020 2020 2020 2020
2020 2020 2019 2020 2020 2019
2020 2020 2019 2020 2020 2019
2020 2020 2019 2020 2020 2019
2020 2020 2019 2020 2020 2019
2020 2020 2019 2020 2020 2019

# date_part (isoyear) with columns and explicit timestamp
query IIIIII
SELECT date_part('isoyear', ts_nano_no_tz), date_part('isoyear', ts_nano_utc), date_part('isoyear', ts_nano_eastern), date_part('isoyear', ts_milli_no_tz), date_part('isoyear', ts_milli_utc), date_part('isoyear', ts_milli_eastern)  FROM source_ts;
----
2020 2020 2020 2020 2020 2020
2020 2020 2020 2020 2020 2020
2020 2020 2020 2020 2020 2020
2020 2020 2020 2020 2020 2020
2020 2020 2020 2020 2020 2020
2020 2020 2020 2020 2020 2020
2020 2020 2020 2020 2020 2020
2020 2020 2020 2020 2020 2020
2020 2020 2020 2020 2020 2020
2020 2020 2020 2020 2020 2020
2020 2020 2020 2020 2020 2020


# date_part (month)
query IIIIII
SELECT date_part('month', ts_nano_no_tz), date_part('month', ts_nano_utc), date_part('month', ts_nano_eastern), date_part('month', ts_milli_no_tz), date_part('month', ts_milli_utc), date_part('month', ts_milli_eastern)  FROM source_ts;
----
1 1 12 1 1 12
1 1 12 1 1 12
9 9 8 9 9 8
1 1 1 1 1 1
1 1 1 1 1 1
1 1 1 1 1 1
1 1 12 1 1 12
1 1 12 1 1 12
1 1 12 1 1 12
1 1 12 1 1 12
1 1 12 1 1 12

# date_part (day)
query IIIIII
SELECT date_part('day', ts_nano_no_tz), date_part('day', ts_nano_utc), date_part('day', ts_nano_eastern), date_part('day', ts_milli_no_tz), date_part('day', ts_milli_utc), date_part('day', ts_milli_eastern)  FROM source_ts;
----
1 1 31 1 1 31
1 1 31 1 1 31
1 1 31 1 1 31
25 25 24 25 25 24
24 24 23 24 24 23
1 1 1 1 1 1
1 1 31 1 1 31
1 1 31 1 1 31
1 1 31 1 1 31
1 1 31 1 1 31
1 1 31 1 1 31

# date_part (hour)
query IIIIII
SELECT date_part('hour', ts_nano_no_tz), date_part('hour', ts_nano_utc), date_part('hour', ts_nano_eastern), date_part('hour', ts_milli_no_tz), date_part('hour', ts_milli_utc), date_part('hour', ts_milli_eastern)  FROM source_ts;
----
0 0 19 0 0 19
0 0 19 0 0 19
0 0 20 0 0 20
0 0 19 0 0 19
0 0 19 0 0 19
12 12 7 12 12 7
0 0 19 0 0 19
0 0 19 0 0 19
0 0 19 0 0 19
0 0 19 0 0 19
0 0 19 0 0 19

# date_part (minute)
query IIIIII
SELECT date_part('minute', ts_nano_no_tz), date_part('minute', ts_nano_utc), date_part('minute', ts_nano_eastern), date_part('minute', ts_milli_no_tz), date_part('minute', ts_milli_utc), date_part('minute', ts_milli_eastern)  FROM source_ts;
----
0 0 0 0 0 0
0 0 0 0 0 0
0 0 0 0 0 0
0 0 0 0 0 0
0 0 0 0 0 0
0 0 0 0 0 0
30 30 30 30 30 30
0 0 0 0 0 0
0 0 0 0 0 0
0 0 0 0 0 0
0 0 0 0 0 0

# date_part (second)
query IIIIII
SELECT date_part('second', ts_nano_no_tz), date_part('second', ts_nano_utc), date_part('second', ts_nano_eastern), date_part('second', ts_milli_no_tz), date_part('second', ts_milli_utc), date_part('second', ts_milli_eastern)  FROM source_ts;
----
0 0 0 0 0 0
0 0 0 0 0 0
0 0 0 0 0 0
0 0 0 0 0 0
0 0 0 0 0 0
0 0 0 0 0 0
0 0 0 0 0 0
30 30 30 30 30 30
0 0 0 0 0 0
0 0 0 0 0 0
0 0 0 0 0 0

# date_part (millisecond)
query IIIIII
SELECT date_part('millisecond', ts_nano_no_tz), date_part('millisecond', ts_nano_utc), date_part('millisecond', ts_nano_eastern), date_part('millisecond', ts_milli_no_tz), date_part('millisecond', ts_milli_utc), date_part('millisecond', ts_milli_eastern)  FROM source_ts;
----
0 0 0 0 0 0
0 0 0 0 0 0
0 0 0 0 0 0
0 0 0 0 0 0
0 0 0 0 0 0
0 0 0 0 0 0
0 0 0 0 0 0
30000 30000 30000 30000 30000 30000
123 123 123 123 123 123
123 123 123 123 123 123
123 123 123 123 123 123

# date_part (microsecond)
query IIIIII
SELECT date_part('microsecond', ts_nano_no_tz), date_part('microsecond', ts_nano_utc), date_part('microsecond', ts_nano_eastern), date_part('microsecond', ts_milli_no_tz), date_part('microsecond', ts_milli_utc), date_part('microsecond', ts_milli_eastern)  FROM source_ts;
----
0 0 0 0 0 0
0 0 0 0 0 0
0 0 0 0 0 0
0 0 0 0 0 0
0 0 0 0 0 0
0 0 0 0 0 0
0 0 0 0 0 0
30000000 30000000 30000000 30000000 30000000 30000000
123000 123000 123000 123000 123000 123000
123456 123456 123456 123000 123000 123000
123456 123456 123456 123000 123000 123000

### Cleanup
statement ok
drop table source_ts;



## "Unit style" tests for types and units on scalar values


query error
SELECT EXTRACT("'''year'''" FROM  timestamp '2020-09-08T12:00:00+00:00')

query error
SELECT EXTRACT("'year'" FROM  timestamp '2020-09-08T12:00:00+00:00')

query I
SELECT date_part('YEAR', CAST('2000-01-01' AS DATE))
----
2000

query I
SELECT EXTRACT(year FROM  timestamp '2020-09-08T12:00:00+00:00')
----
2020

query I
SELECT EXTRACT("year" FROM  timestamp '2020-09-08T12:00:00+00:00')
----
2020

query I
SELECT EXTRACT('year' FROM  timestamp '2020-09-08T12:00:00+00:00')
----
2020

query I
SELECT date_part('ISOYEAR', CAST('2000-01-01' AS DATE))
----
1999

query I
SELECT EXTRACT(isoyear FROM  timestamp '2020-09-08T12:00:00+00:00')
----
2020

query I
SELECT EXTRACT("isoyear" FROM  timestamp '2020-09-08T12:00:00+00:00')
----
2020

query I
SELECT EXTRACT('isoyear' FROM  timestamp '2020-09-08T12:00:00+00:00')
----
2020

query I
SELECT date_part('QUARTER', CAST('2000-01-01' AS DATE))
----
1

query I
SELECT EXTRACT(quarter FROM to_timestamp('2020-09-08T12:00:00+00:00'))
----
3

query I
SELECT EXTRACT("quarter" FROM to_timestamp('2020-09-08T12:00:00+00:00'))
----
3

query I
SELECT EXTRACT('quarter' FROM to_timestamp('2020-09-08T12:00:00+00:00'))
----
3

query I
SELECT date_part('MONTH', CAST('2000-01-01' AS DATE))
----
1

query I
SELECT EXTRACT(month FROM to_timestamp('2020-09-08T12:00:00+00:00'))
----
9

query I
SELECT EXTRACT("month" FROM to_timestamp('2020-09-08T12:00:00+00:00'))
----
9

query I
SELECT EXTRACT('month' FROM to_timestamp('2020-09-08T12:00:00+00:00'))
----
9

query I
SELECT date_part('WEEK', CAST('2003-01-01' AS DATE))
----
1

query I
SELECT EXTRACT(WEEK FROM to_timestamp('2020-09-08T12:00:00+00:00'))
----
37

query I
SELECT EXTRACT("WEEK" FROM to_timestamp('2020-09-08T12:00:00+00:00'))
----
37

query I
SELECT EXTRACT('WEEK' FROM to_timestamp('2020-09-08T12:00:00+00:00'))
----
37

query I
SELECT date_part('DAY', CAST('2000-01-01' AS DATE))
----
1

query I
SELECT EXTRACT(day FROM to_timestamp('2020-09-08T12:00:00+00:00'))
----
8

query I
SELECT EXTRACT("day" FROM to_timestamp('2020-09-08T12:00:00+00:00'))
----
8

query I
SELECT EXTRACT('day' FROM to_timestamp('2020-09-08T12:00:00+00:00'))
----
8

query I
SELECT date_part('DOY', CAST('2000-01-01' AS DATE))
----
1

query I
SELECT EXTRACT(doy FROM to_timestamp('2020-09-08T12:00:00+00:00'))
----
252

query I
SELECT EXTRACT("doy" FROM to_timestamp('2020-09-08T12:00:00+00:00'))
----
252

query I
SELECT EXTRACT('doy' FROM to_timestamp('2020-09-08T12:00:00+00:00'))
----
252

query I
SELECT date_part('DOW', CAST('2000-01-01' AS DATE))
----
6

query I
SELECT EXTRACT(dow FROM to_timestamp('2020-09-08T12:00:00+00:00'))
----
2

query I
SELECT EXTRACT("dow" FROM to_timestamp('2020-09-08T12:00:00+00:00'))
----
2

query I
SELECT EXTRACT('dow' FROM to_timestamp('2020-09-08T12:00:00+00:00'))
----
2

query I
SELECT date_part('HOUR', CAST('2000-01-01' AS DATE))
----
0

query I
SELECT EXTRACT(hour FROM to_timestamp('2020-09-08T12:03:03+00:00'))
----
12

query I
SELECT EXTRACT("hour" FROM to_timestamp('2020-09-08T12:03:03+00:00'))
----
12

query I
SELECT EXTRACT('hour' FROM to_timestamp('2020-09-08T12:03:03+00:00'))
----
12

query I
SELECT EXTRACT(minute FROM to_timestamp('2020-09-08T12:12:00+00:00'))
----
12

query I
SELECT EXTRACT("minute" FROM to_timestamp('2020-09-08T12:12:00+00:00'))
----
12

query I
SELECT EXTRACT('minute' FROM to_timestamp('2020-09-08T12:12:00+00:00'))
----
12

query I
SELECT date_part('minute', to_timestamp('2020-09-08T12:12:00+00:00'))
----
12

# make sure the return type is integer
query T
SELECT arrow_typeof(date_part('minute', to_timestamp('2020-09-08T12:12:00+00:00')))
----
Int32

query I
SELECT EXTRACT(second FROM timestamp '2020-09-08T12:00:12.12345678+00:00')
----
12

query I
SELECT EXTRACT(millisecond FROM timestamp '2020-09-08T12:00:12.12345678+00:00')
----
12123

query I
SELECT EXTRACT(microsecond FROM timestamp '2020-09-08T12:00:12.12345678+00:00')
----
12123456

query error DataFusion error: This feature is not implemented: Date part Nanosecond not supported
SELECT EXTRACT(nanosecond FROM timestamp '2020-09-08T12:00:12.12345678+00:00')

query I
SELECT EXTRACT("second" FROM timestamp '2020-09-08T12:00:12.12345678+00:00')
----
12

query I
SELECT EXTRACT("millisecond" FROM timestamp '2020-09-08T12:00:12.12345678+00:00')
----
12123

query I
SELECT EXTRACT("microsecond" FROM timestamp '2020-09-08T12:00:12.12345678+00:00')
----
12123456

query error DataFusion error: This feature is not implemented: Date part Nanosecond not supported
SELECT EXTRACT("nanosecond" FROM timestamp '2020-09-08T12:00:12.12345678+00:00')

query I
SELECT EXTRACT('second' FROM timestamp '2020-09-08T12:00:12.12345678+00:00')
----
12

query I
SELECT EXTRACT('millisecond' FROM timestamp '2020-09-08T12:00:12.12345678+00:00')
----
12123

query I
SELECT EXTRACT('microsecond' FROM timestamp '2020-09-08T12:00:12.12345678+00:00')
----
12123456

query error DataFusion error: This feature is not implemented: Date part Nanosecond not supported
SELECT EXTRACT('nanosecond' FROM timestamp '2020-09-08T12:00:12.12345678+00:00')


# Keep precision when coercing Utf8 to Timestamp
query I
SELECT date_part('second', timestamp '2020-09-08T12:00:12.12345678+00:00')
----
12

query I
SELECT date_part('millisecond', timestamp '2020-09-08T12:00:12.12345678+00:00')
----
12123

query I
SELECT date_part('microsecond', timestamp '2020-09-08T12:00:12.12345678+00:00')
----
12123456

query error DataFusion error: This feature is not implemented: Date part Nanosecond not supported
SELECT date_part('nanosecond', timestamp '2020-09-08T12:00:12.12345678+00:00')


query I
SELECT date_part('second', '2020-09-08T12:00:12.12345678+00:00')
----
12

query I
SELECT date_part('millisecond', '2020-09-08T12:00:12.12345678+00:00')
----
12123

query I
SELECT date_part('microsecond', '2020-09-08T12:00:12.12345678+00:00')
----
12123456

query error DataFusion error: This feature is not implemented: Date part Nanosecond not supported
SELECT date_part('nanosecond', '2020-09-08T12:00:12.12345678+00:00')

# test_date_part_time

## time32 seconds
query I
SELECT date_part('hour', arrow_cast('23:32:50'::time, 'Time32(Second)'))
----
23

query I
SELECT extract(hour from arrow_cast('23:32:50'::time, 'Time32(Second)'))
----
23

query I
SELECT date_part('minute', arrow_cast('23:32:50'::time, 'Time32(Second)'))
----
32

query I
SELECT extract(minute from arrow_cast('23:32:50'::time, 'Time32(Second)'))
----
32

query I
SELECT date_part('second', arrow_cast('23:32:50'::time, 'Time32(Second)'))
----
50

query I
SELECT extract(second from arrow_cast('23:32:50'::time, 'Time32(Second)'))
----
50

query I
SELECT date_part('millisecond', arrow_cast('23:32:50'::time, 'Time32(Second)'))
----
50000

query I
SELECT extract(millisecond from arrow_cast('23:32:50'::time, 'Time32(Second)'))
----
50000

query I
SELECT date_part('microsecond', arrow_cast('23:32:50'::time, 'Time32(Second)'))
----
50000000

query I
SELECT extract(microsecond from arrow_cast('23:32:50'::time, 'Time32(Second)'))
----
50000000

query error DataFusion error: This feature is not implemented: Date part Nanosecond not supported
SELECT extract(nanosecond from arrow_cast('23:32:50'::time, 'Time32(Second)'))

query R
SELECT date_part('epoch', arrow_cast('23:32:50'::time, 'Time32(Second)'))
----
84770

query R
SELECT extract(epoch from arrow_cast('23:32:50'::time, 'Time32(Second)'))
----
84770

## time32 milliseconds
query I
SELECT date_part('hour', arrow_cast('23:32:50.123'::time, 'Time32(Millisecond)'))
----
23

query I
SELECT extract(hour from arrow_cast('23:32:50.123'::time, 'Time32(Millisecond)'))
----
23

query I
SELECT date_part('minute', arrow_cast('23:32:50.123'::time, 'Time32(Millisecond)'))
----
32

query I
SELECT extract(minute from arrow_cast('23:32:50.123'::time, 'Time32(Millisecond)'))
----
32

query I
SELECT date_part('second', arrow_cast('23:32:50.123'::time, 'Time32(Millisecond)'))
----
50

query I
SELECT extract(second from arrow_cast('23:32:50.123'::time, 'Time32(Millisecond)'))
----
50

query I
SELECT date_part('millisecond', arrow_cast('23:32:50.123'::time, 'Time32(Millisecond)'))
----
50123

query I
SELECT extract(millisecond from arrow_cast('23:32:50.123'::time, 'Time32(Millisecond)'))
----
50123

query I
SELECT date_part('microsecond', arrow_cast('23:32:50.123'::time, 'Time32(Millisecond)'))
----
50123000

query I
SELECT extract(microsecond from arrow_cast('23:32:50.123'::time, 'Time32(Millisecond)'))
----
50123000

query error DataFusion error: This feature is not implemented: Date part Nanosecond not supported
SELECT extract(nanosecond from arrow_cast('23:32:50.123'::time, 'Time32(Millisecond)'))

query R
SELECT date_part('epoch', arrow_cast('23:32:50.123'::time, 'Time32(Millisecond)'))
----
84770.123

query R
SELECT extract(epoch from arrow_cast('23:32:50.123'::time, 'Time32(Millisecond)'))
----
84770.123

## time64 microseconds
query I
SELECT date_part('hour', arrow_cast('23:32:50.123456'::time, 'Time64(Microsecond)'))
----
23

query I
SELECT extract(hour from arrow_cast('23:32:50.123456'::time, 'Time64(Microsecond)'))
----
23

query I
SELECT date_part('minute', arrow_cast('23:32:50.123456'::time, 'Time64(Microsecond)'))
----
32

query I
SELECT extract(minute from arrow_cast('23:32:50.123456'::time, 'Time64(Microsecond)'))
----
32

query I
SELECT date_part('second', arrow_cast('23:32:50.123456'::time, 'Time64(Microsecond)'))
----
50

query I
SELECT extract(second from arrow_cast('23:32:50.123456'::time, 'Time64(Microsecond)'))
----
50

query I
SELECT date_part('millisecond', arrow_cast('23:32:50.123456'::time, 'Time64(Microsecond)'))
----
50123

query I
SELECT extract(millisecond from arrow_cast('23:32:50.123456'::time, 'Time64(Microsecond)'))
----
50123

query I
SELECT date_part('microsecond', arrow_cast('23:32:50.123456'::time, 'Time64(Microsecond)'))
----
50123456

query I
SELECT extract(microsecond from arrow_cast('23:32:50.123456'::time, 'Time64(Microsecond)'))
----
50123456

query error DataFusion error: This feature is not implemented: Date part Nanosecond not supported
SELECT extract(nanosecond from arrow_cast('23:32:50.123456'::time, 'Time64(Microsecond)'))

query R
SELECT date_part('epoch', arrow_cast('23:32:50.123456'::time, 'Time64(Microsecond)'))
----
84770.123456

query R
SELECT extract(epoch from arrow_cast('23:32:50.123456'::time, 'Time64(Microsecond)'))
----
84770.123456

## time64 nanoseconds
query I
SELECT date_part('hour', arrow_cast('23:32:50.123456789'::time, 'Time64(Nanosecond)'))
----
23

query I
SELECT extract(hour from arrow_cast('23:32:50.123456789'::time, 'Time64(Nanosecond)'))
----
23

query I
SELECT date_part('minute', arrow_cast('23:32:50.123456789'::time, 'Time64(Nanosecond)'))
----
32

query I
SELECT extract(minute from arrow_cast('23:32:50.123456789'::time, 'Time64(Nanosecond)'))
----
32

query I
SELECT date_part('second', arrow_cast('23:32:50.123456789'::time, 'Time64(Nanosecond)'))
----
50

query I
select extract(second from '2024-08-09T12:13:14')
----
14

query I
select extract(second from timestamp '2024-08-09T12:13:14')
----
14

query I
select extract(seconds from '2024-08-09T12:13:14')
----
14

query I
select extract(seconds from timestamp '2024-08-09T12:13:14')
----
14

query I
SELECT extract(second from arrow_cast('23:32:50.123456789'::time, 'Time64(Nanosecond)'))
----
50

query I
SELECT date_part('millisecond', arrow_cast('23:32:50.123456789'::time, 'Time64(Nanosecond)'))
----
50123

query I
SELECT extract(millisecond from arrow_cast('23:32:50.123456789'::time, 'Time64(Nanosecond)'))
----
50123

# just some floating point stuff happening in the result here
query I
SELECT date_part('microsecond', arrow_cast('23:32:50.123456789'::time, 'Time64(Nanosecond)'))
----
50123456

query I
SELECT extract(microsecond from arrow_cast('23:32:50.123456789'::time, 'Time64(Nanosecond)'))
----
50123456

query I
SELECT extract(us from arrow_cast('23:32:50.123456789'::time, 'Time64(Nanosecond)'))
----
50123456

query error DataFusion error: This feature is not implemented: Date part Nanosecond not supported
SELECT date_part('nanosecond', arrow_cast('23:32:50.123456789'::time, 'Time64(Nanosecond)'))

query R
SELECT date_part('epoch', arrow_cast('23:32:50.123456789'::time, 'Time64(Nanosecond)'))
----
84770.123456789

query R
SELECT extract(epoch from arrow_cast('23:32:50.123456789'::time, 'Time64(Nanosecond)'))
----
84770.123456789

# test_extract_epoch

query R
SELECT extract(epoch from '1870-01-01T07:29:10.256'::timestamp)
----
-3155646649.744

query R
SELECT extract(epoch from '2000-01-01T00:00:00.000'::timestamp)
----
946684800

query R
SELECT extract(epoch from to_timestamp('2000-01-01T00:00:00+00:00'))
----
946684800

query R
SELECT extract(epoch from NULL::timestamp)
----
NULL

query R
SELECT extract(epoch from arrow_cast('1970-01-01', 'Date32'))
----
0

query R
SELECT extract(epoch from arrow_cast('1970-01-02', 'Date32'))
----
86400

query R
SELECT extract(epoch from arrow_cast('1970-01-11', 'Date32'))
----
864000

query R
SELECT extract(epoch from arrow_cast('1969-12-31', 'Date32'))
----
-86400

query R
SELECT extract(epoch from arrow_cast('1970-01-01', 'Date64'))
----
0

query R
SELECT extract(epoch from arrow_cast('1970-01-02', 'Date64'))
----
86400

query R
SELECT extract(epoch from arrow_cast('1970-01-11', 'Date64'))
----
864000

query R
SELECT extract(epoch from arrow_cast('1969-12-31', 'Date64'))
----
-86400

# test_extract_interval

query I
SELECT extract(year from arrow_cast('10 years', 'Interval(YearMonth)'))
----
10

query I
SELECT extract(month from arrow_cast('10 years', 'Interval(YearMonth)'))
----
0

query I
SELECT extract(year from arrow_cast('10 months', 'Interval(YearMonth)'))
----
0

query I
SELECT extract(month from arrow_cast('10 months', 'Interval(YearMonth)'))
----
10

query I
SELECT extract(year from arrow_cast('20 months', 'Interval(YearMonth)'))
----
1

query I
SELECT extract(month from arrow_cast('20 months', 'Interval(YearMonth)'))
----
8

query error DataFusion error: Arrow error: Compute error: YearISO does not support: Interval\(YearMonth\)
SELECT extract(isoyear from arrow_cast('10 years', 'Interval(YearMonth)'))

query error DataFusion error: Arrow error: Compute error: Year does not support: Interval\(DayTime\)
SELECT extract(year from arrow_cast('10 days', 'Interval(DayTime)'))

query error DataFusion error: Arrow error: Compute error: YearISO does not support: Interval\(DayTime\)
SELECT extract(isoyear from arrow_cast('10 days', 'Interval(DayTime)'))

query error DataFusion error: Arrow error: Compute error: Month does not support: Interval\(DayTime\)
SELECT extract(month from arrow_cast('10 days', 'Interval(DayTime)'))

query I
SELECT extract(day from arrow_cast('10 days', 'Interval(DayTime)'))
----
10

query I
SELECT extract(day from arrow_cast('14400 minutes', 'Interval(DayTime)'))
----
0

query I
SELECT extract(minute from arrow_cast('14400 minutes', 'Interval(DayTime)'))
----
0

query I
SELECT extract(second from arrow_cast('5.1 seconds', 'Interval(DayTime)'))
----
5

query I
SELECT extract(second from arrow_cast('14400 minutes', 'Interval(DayTime)'))
----
0

query I
SELECT extract(second from arrow_cast('2 months', 'Interval(MonthDayNano)'))
----
0

query I
SELECT extract(second from arrow_cast('2 days', 'Interval(MonthDayNano)'))
----
0

query I
SELECT extract(second from arrow_cast('2 seconds', 'Interval(MonthDayNano)'))
----
2

query I
SELECT extract(seconds from arrow_cast('2 seconds', 'Interval(MonthDayNano)'))
----
2

query R
SELECT extract(epoch from arrow_cast('2 seconds', 'Interval(MonthDayNano)'))
----
2

query I
SELECT extract(milliseconds from arrow_cast('2 seconds', 'Interval(MonthDayNano)'))
----
2000

query I
SELECT extract(second from arrow_cast('2030 milliseconds', 'Interval(MonthDayNano)'))
----
2

query I
SELECT extract(second from arrow_cast(NULL, 'Interval(MonthDayNano)'))
----
NULL

# extract epoch from intervals
query R
SELECT extract(epoch from interval '15 minutes')
----
900

query R
SELECT extract(epoch from interval '1 hour')
----
3600

query R
SELECT extract(epoch from interval '1 day')
----
86400

query R
SELECT extract(epoch from interval '1 month')
----
2592000

query R
SELECT extract(epoch from arrow_cast('3 days', 'Interval(DayTime)'))
----
259200

query R
SELECT extract(epoch from arrow_cast('100 milliseconds', 'Interval(MonthDayNano)'))
----
0.1

query R
SELECT extract(epoch from arrow_cast('500 microseconds', 'Interval(MonthDayNano)'))
----
0.0005

query R
SELECT extract(epoch from arrow_cast('2500 nanoseconds', 'Interval(MonthDayNano)'))
----
0.0000025

query R
SELECT extract(epoch from arrow_cast('1 month 2 days 500 milliseconds', 'Interval(MonthDayNano)'))
----
2764800.5

query R
SELECT extract(epoch from arrow_cast('2 months', 'Interval(YearMonth)'))
----
5184000

statement ok
create table t (id int, i interval) as values
  (0, interval '5 months 1 day 10 nanoseconds'),
  (1, interval '1 year 3 months'),
  (2, interval '3 days 2 milliseconds'),
  (3, interval '2 seconds'),
  (4, interval '8 months'),
  (5, NULL);

query III
select
  id,
  extract(second from i),
  extract(month from i)
from t
order by id;
----
0 0 5
1 0 3
2 0 0
3 2 0
4 0 8
5 NULL NULL

statement ok
drop table t;

# test_extract_duration

query I
SELECT extract(second from arrow_cast(2, 'Duration(Second)'))
----
2

query I
SELECT extract(seconds from arrow_cast(2, 'Duration(Second)'))
----
2

query R
SELECT extract(epoch from arrow_cast(2, 'Duration(Second)'))
----
2

query I
SELECT extract(millisecond from arrow_cast(2, 'Duration(Second)'))
----
2000

query I
SELECT extract(second from arrow_cast(2, 'Duration(Millisecond)'))
----
0

query I
SELECT extract(second from arrow_cast(2002, 'Duration(Millisecond)'))
----
2

query I
SELECT extract(millisecond from arrow_cast(2002, 'Duration(Millisecond)'))
----
2002

query I
SELECT extract(day from arrow_cast(864000, 'Duration(Second)'))
----
10

query error DataFusion error: Arrow error: Compute error: Month does not support: Duration\(s\)
SELECT extract(month from arrow_cast(864000, 'Duration(Second)'))

query error DataFusion error: Arrow error: Compute error: Year does not support: Duration\(s\)
SELECT extract(year from arrow_cast(864000, 'Duration(Second)'))

query error DataFusion error: Arrow error: Compute error: YearISO does not support: Duration\(s\)
SELECT extract(isoyear from arrow_cast(864000, 'Duration(Second)'))

query I
SELECT extract(day from arrow_cast(NULL, 'Duration(Second)'))
----
NULL

# test_extract_date_part_func

query B
SELECT (date_part('year', now()) = EXTRACT(year FROM now()))
----
true

query B
SELECT (date_part('isoyear', now()) = EXTRACT(isoyear FROM now()))
----
true

query B
SELECT (date_part('quarter', now()) = EXTRACT(quarter FROM now()))
----
true

query B
SELECT (date_part('month', now()) = EXTRACT(month FROM now()))
----
true

query B
SELECT (date_part('week', now()) = EXTRACT(week FROM now()))
----
true

query B
SELECT (date_part('day', now()) = EXTRACT(day FROM now()))
----
true

query B
SELECT (date_part('hour', now()) = EXTRACT(hour FROM now()))
----
true

query B
SELECT (date_part('minute', now()) = EXTRACT(minute FROM now()))
----
true

query B
SELECT (date_part('second', now()) = EXTRACT(second FROM now()))
----
true

query B
SELECT (date_part('millisecond', now()) = EXTRACT(millisecond FROM now()))
----
true

query B
SELECT (date_part('microsecond', now()) = EXTRACT(microsecond FROM now()))
----
true

query error DataFusion error: This feature is not implemented: Date part Nanosecond not supported
SELECT (date_part('nanosecond', now()) = EXTRACT(nanosecond FROM now()))

query I
SELECT date_part('ISODOW', CAST('2000-01-01' AS DATE))
----
5

query I
SELECT EXTRACT(isodow FROM to_timestamp('2020-09-08T12:00:00+00:00'))
----
1

query I
SELECT EXTRACT("isodow" FROM to_timestamp('2020-09-08T12:00:00+00:00'))
----
1

query I
SELECT EXTRACT('isodow' FROM to_timestamp('2020-09-08T12:00:00+00:00'))
----
1

## Preimage tests

statement ok
create table t1(c DATE) as VALUES (NULL), ('1990-01-01'), ('2024-01-01'), ('2030-01-01');

# Simple optimizations, col on LHS

query D
select c from t1 where extract(year from c) = 2024;
----
2024-01-01

query D
select c from t1 where extract(year from c) <> 2024;
----
1990-01-01
2030-01-01 

query D
select c from t1 where extract(year from c) > 2024;
----
2030-01-01

query D
select c from t1 where extract(year from c) < 2024;
----
1990-01-01

query D
select c from t1 where extract(year from c) >= 2024;
----
2024-01-01
2030-01-01

query D
select c from t1 where extract(year from c) <= 2024;
----
1990-01-01
2024-01-01

query D
select c from t1 where extract(year from c) is not distinct from 2024
----
2024-01-01

query D
select c from t1 where extract(year from c) is distinct from 2024
----
NULL
1990-01-01
2030-01-01

# IN list optimization
query D
select c from t1 where extract(year from c) in (1990, 2024);
----
1990-01-01
2024-01-01

# NOT IN list optimization (NULL does not satisfy NOT IN)
query D
select c from t1 where extract(year from c) not in (1990, 2024);
----
2030-01-01

# Check that date_part is not in the explain statements

query TT
explain select c from t1 where extract (year from c) = 2024
----
logical_plan
01)Filter: t1.c >= Date32("2024-01-01") AND t1.c < Date32("2025-01-01")
02)--TableScan: t1 projection=[c]
physical_plan
01)FilterExec: c@0 >= 2024-01-01 AND c@0 < 2025-01-01
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c from t1 where extract (year from c) <> 2024
----
logical_plan
01)Filter: t1.c < Date32("2024-01-01") OR t1.c >= Date32("2025-01-01")
02)--TableScan: t1 projection=[c]
physical_plan
01)FilterExec: c@0 < 2024-01-01 OR c@0 >= 2025-01-01
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c from t1 where extract (year from c) > 2024
----
logical_plan
01)Filter: t1.c >= Date32("2025-01-01")
02)--TableScan: t1 projection=[c]
physical_plan
01)FilterExec: c@0 >= 2025-01-01
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c from t1 where extract (year from c) < 2024
----
logical_plan
01)Filter: t1.c < Date32("2024-01-01")
02)--TableScan: t1 projection=[c]
physical_plan
01)FilterExec: c@0 < 2024-01-01
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c from t1 where extract (year from c) >= 2024
----
logical_plan
01)Filter: t1.c >= Date32("2024-01-01")
02)--TableScan: t1 projection=[c]
physical_plan
01)FilterExec: c@0 >= 2024-01-01
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c from t1 where extract (year from c) <= 2024
----
logical_plan
01)Filter: t1.c < Date32("2025-01-01")
02)--TableScan: t1 projection=[c]
physical_plan
01)FilterExec: c@0 < 2025-01-01
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c from t1 where extract (year from c) is not distinct from 2024
----
logical_plan
01)Filter: t1.c IS NOT NULL AND t1.c >= Date32("2024-01-01") AND t1.c < Date32("2025-01-01")
02)--TableScan: t1 projection=[c]
physical_plan
01)FilterExec: c@0 IS NOT NULL AND c@0 >= 2024-01-01 AND c@0 < 2025-01-01
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c from t1 where extract (year from c) is distinct from 2024
----
logical_plan
01)Filter: t1.c < Date32("2024-01-01") OR t1.c >= Date32("2025-01-01") OR t1.c IS NULL
02)--TableScan: t1 projection=[c]
physical_plan
01)FilterExec: c@0 < 2024-01-01 OR c@0 >= 2025-01-01 OR c@0 IS NULL
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c from t1 where extract (year from c) in (1990, 2024)
----
logical_plan
01)Filter: t1.c >= Date32("1990-01-01") AND t1.c < Date32("1991-01-01") OR t1.c >= Date32("2024-01-01") AND t1.c < Date32("2025-01-01")
02)--TableScan: t1 projection=[c]
physical_plan
01)FilterExec: c@0 >= 1990-01-01 AND c@0 < 1991-01-01 OR c@0 >= 2024-01-01 AND c@0 < 2025-01-01
02)--DataSourceExec: partitions=1, partition_sizes=[1]

# Simple optimizations, column on RHS

query D
select c from t1 where 2024 = extract(year from c);
----
2024-01-01

query D
select c from t1 where 2024 <> extract(year from c);
----
1990-01-01
2030-01-01

query D
select c from t1 where 2024 < extract(year from c);
----
2030-01-01

query D
select c from t1 where 2024 > extract(year from c);
----
1990-01-01

query D
select c from t1 where 2024 <= extract(year from c);
----
2024-01-01
2030-01-01

query D
select c from t1 where 2024 >= extract(year from c);
----
1990-01-01
2024-01-01

query D
select c from t1 where 2024 is not distinct from extract(year from c);
----
2024-01-01

query D
select c from t1 where 2024 is distinct from extract(year from c);
----
NULL
1990-01-01
2030-01-01

# Check explain statements for optimizations for other interval types

query TT
explain select c from t1 where extract (quarter from c) = 2024
----
logical_plan
01)Filter: date_part(Utf8("QUARTER"), t1.c) = Int32(2024)
02)--TableScan: t1 projection=[c]
physical_plan
01)FilterExec: date_part(QUARTER, c@0) = 2024
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c from t1 where extract (month from c) = 2024
----
logical_plan
01)Filter: date_part(Utf8("MONTH"), t1.c) = Int32(2024)
02)--TableScan: t1 projection=[c]
physical_plan
01)FilterExec: date_part(MONTH, c@0) = 2024
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c from t1 where extract (week from c) = 2024
----
logical_plan
01)Filter: date_part(Utf8("WEEK"), t1.c) = Int32(2024)
02)--TableScan: t1 projection=[c]
physical_plan
01)FilterExec: date_part(WEEK, c@0) = 2024
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c from t1 where extract (day from c) = 2024
----
logical_plan
01)Filter: date_part(Utf8("DAY"), t1.c) = Int32(2024)
02)--TableScan: t1 projection=[c]
physical_plan
01)FilterExec: date_part(DAY, c@0) = 2024
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c from t1 where extract (hour from c) = 2024
----
logical_plan
01)Filter: date_part(Utf8("HOUR"), t1.c) = Int32(2024)
02)--TableScan: t1 projection=[c]
physical_plan
01)FilterExec: date_part(HOUR, c@0) = 2024
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c from t1 where extract (minute from c) = 2024
----
logical_plan
01)Filter: date_part(Utf8("MINUTE"), t1.c) = Int32(2024)
02)--TableScan: t1 projection=[c]
physical_plan
01)FilterExec: date_part(MINUTE, c@0) = 2024
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c from t1 where extract (second from c) = 2024
----
logical_plan
01)Filter: date_part(Utf8("SECOND"), t1.c) = Int32(2024)
02)--TableScan: t1 projection=[c]
physical_plan
01)FilterExec: date_part(SECOND, c@0) = 2024
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c from t1 where extract (millisecond from c) = 2024
----
logical_plan
01)Filter: date_part(Utf8("MILLISECOND"), t1.c) = Int32(2024)
02)--TableScan: t1 projection=[c]
physical_plan
01)FilterExec: date_part(MILLISECOND, c@0) = 2024
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c from t1 where extract (microsecond from c) = 2024
----
logical_plan
01)Filter: date_part(Utf8("MICROSECOND"), t1.c) = Int32(2024)
02)--TableScan: t1 projection=[c]
physical_plan
01)FilterExec: date_part(MICROSECOND, c@0) = 2024
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c from t1 where extract (nanosecond from c) = 2024
----
logical_plan
01)Filter: date_part(Utf8("NANOSECOND"), t1.c) = Int32(2024)
02)--TableScan: t1 projection=[c]
physical_plan
01)FilterExec: date_part(NANOSECOND, c@0) = 2024
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c from t1 where extract (dow from c) = 2024
----
logical_plan
01)Filter: date_part(Utf8("DOW"), t1.c) = Int32(2024)
02)--TableScan: t1 projection=[c]
physical_plan
01)FilterExec: date_part(DOW, c@0) = 2024
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c from t1 where extract (doy from c) = 2024
----
logical_plan
01)Filter: date_part(Utf8("DOY"), t1.c) = Int32(2024)
02)--TableScan: t1 projection=[c]
physical_plan
01)FilterExec: date_part(DOY, c@0) = 2024
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c from t1 where extract (epoch from c) = 2024
----
logical_plan
01)Filter: date_part(Utf8("EPOCH"), t1.c) = Float64(2024)
02)--TableScan: t1 projection=[c]
physical_plan
01)FilterExec: date_part(EPOCH, c@0) = 2024
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c from t1 where extract (isodow from c) = 2024
----
logical_plan
01)Filter: date_part(Utf8("ISODOW"), t1.c) = Int32(2024)
02)--TableScan: t1 projection=[c]
physical_plan
01)FilterExec: date_part(ISODOW, c@0) = 2024
02)--DataSourceExec: partitions=1, partition_sizes=[1]

# Simple optimize different datatypes

statement ok
create table t2(
    c1_date32 DATE,
    c2_ts_sec timestamp,
    c3_ts_mili timestamp,
    c4_ts_micro timestamp,
    c5_ts_nano timestamp
) as VALUES
    (NULL,
     NULL,
     NULL,
     NULL,
     NULL),
    ('1990-05-20',
     '1990-05-20T00:00:10'::timestamp,
     '1990-05-20T00:00:10.987'::timestamp,
     '1990-05-20T00:00:10.987654'::timestamp,
     '1990-05-20T00:00:10.987654321'::timestamp),
    ('2024-01-01',
     '2024-01-01T00:00:00'::timestamp,
     '2024-01-01T00:00:00.123'::timestamp,
     '2024-01-01T00:00:00.123456'::timestamp,
     '2024-01-01T00:00:00.123456789'::timestamp),
    ('2030-12-31',
     '2030-12-31T23:59:59'::timestamp,
     '2030-12-31T23:59:59.001'::timestamp,
     '2030-12-31T23:59:59.001234'::timestamp,
     '2030-12-31T23:59:59.001234567'::timestamp)
;

query D
select c1_date32 from t2 where extract(year from c1_date32) = 2024;
----
2024-01-01

query D
select c1_date32 from t2 where extract(year from c1_date32) <> 2024;
----
1990-05-20
2030-12-31 

query P
select c2_ts_sec from t2 where extract(year from c2_ts_sec) > 2024;
----
2030-12-31T23:59:59

query P
select c3_ts_mili from t2 where extract(year from c3_ts_mili) < 2024;
----
1990-05-20T00:00:10.987

query P
select c4_ts_micro from t2 where extract(year from c4_ts_micro) >= 2024;
----
2024-01-01T00:00:00.123456
2030-12-31T23:59:59.001234

query P
select c5_ts_nano from t2 where extract(year from c5_ts_nano) <= 2024;
----
1990-05-20T00:00:10.987654321
2024-01-01T00:00:00.123456789

query D
select c1_date32 from t2 where extract(year from c1_date32) is not distinct from 2024
----
2024-01-01

query D
select c1_date32 from t2 where extract(year from c1_date32) is distinct from 2024
----
NULL
1990-05-20
2030-12-31

# Check that date_part is not in the explain statements for other datatypes

query TT
explain select c1_date32 from t2 where extract (year from c1_date32) = 2024
----
logical_plan
01)Filter: t2.c1_date32 >= Date32("2024-01-01") AND t2.c1_date32 < Date32("2025-01-01")
02)--TableScan: t2 projection=[c1_date32]
physical_plan
01)FilterExec: c1_date32@0 >= 2024-01-01 AND c1_date32@0 < 2025-01-01
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c1_date32 from t2 where extract (year from c1_date32) <> 2024
----
logical_plan
01)Filter: t2.c1_date32 < Date32("2024-01-01") OR t2.c1_date32 >= Date32("2025-01-01")
02)--TableScan: t2 projection=[c1_date32]
physical_plan
01)FilterExec: c1_date32@0 < 2024-01-01 OR c1_date32@0 >= 2025-01-01
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c2_ts_sec from t2 where extract (year from c2_ts_sec) > 2024
----
logical_plan
01)Filter: t2.c2_ts_sec >= TimestampNanosecond(1735689600000000000, None)
02)--TableScan: t2 projection=[c2_ts_sec]
physical_plan
01)FilterExec: c2_ts_sec@0 >= 1735689600000000000
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c3_ts_mili from t2 where extract (year from c3_ts_mili) < 2024
----
logical_plan
01)Filter: t2.c3_ts_mili < TimestampNanosecond(1704067200000000000, None)
02)--TableScan: t2 projection=[c3_ts_mili]
physical_plan
01)FilterExec: c3_ts_mili@0 < 1704067200000000000
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c4_ts_micro from t2 where extract (year from c4_ts_micro) >= 2024
----
logical_plan
01)Filter: t2.c4_ts_micro >= TimestampNanosecond(1704067200000000000, None)
02)--TableScan: t2 projection=[c4_ts_micro]
physical_plan
01)FilterExec: c4_ts_micro@0 >= 1704067200000000000
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c5_ts_nano from t2 where extract (year from c5_ts_nano) <= 2024
----
logical_plan
01)Filter: t2.c5_ts_nano < TimestampNanosecond(1735689600000000000, None)
02)--TableScan: t2 projection=[c5_ts_nano]
physical_plan
01)FilterExec: c5_ts_nano@0 < 1735689600000000000
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c1_date32 from t2 where extract (year from c1_date32) is not distinct from 2024
----
logical_plan
01)Filter: t2.c1_date32 IS NOT NULL AND t2.c1_date32 >= Date32("2024-01-01") AND t2.c1_date32 < Date32("2025-01-01")
02)--TableScan: t2 projection=[c1_date32]
physical_plan
01)FilterExec: c1_date32@0 IS NOT NULL AND c1_date32@0 >= 2024-01-01 AND c1_date32@0 < 2025-01-01
02)--DataSourceExec: partitions=1, partition_sizes=[1]

query TT
explain select c1_date32 from t2 where extract (year from c1_date32) is distinct from 2024
----
logical_plan
01)Filter: t2.c1_date32 < Date32("2024-01-01") OR t2.c1_date32 >= Date32("2025-01-01") OR t2.c1_date32 IS NULL
02)--TableScan: t2 projection=[c1_date32]
physical_plan
01)FilterExec: c1_date32@0 < 2024-01-01 OR c1_date32@0 >= 2025-01-01 OR c1_date32@0 IS NULL
02)--DataSourceExec: partitions=1, partition_sizes=[1]

# Preimage with timestamp with America/New_York timezone

statement ok
SET datafusion.execution.time_zone = 'America/New_York';

statement ok
create table t3(
    c1_ts_tz timestamptz
) as VALUES
    (NULL),
    ('2024-01-01T04:59:59Z'::timestamptz), -- local 2023-12-31 23:59:59 -05
    ('2024-01-01T05:00:00Z'::timestamptz), -- local 2024-01-01 00:00:00 -05
    ('2025-01-01T04:59:59Z'::timestamptz), -- local 2024-12-31 23:59:59 -05
    ('2025-01-01T05:00:00Z'::timestamptz)  -- local 2025-01-01 00:00:00 -05
;

query P
select c1_ts_tz
from t3
where extract(year from c1_ts_tz) = 2024
order by c1_ts_tz
----
2024-01-01T00:00:00-05:00
2024-12-31T23:59:59-05:00

query TT
explain select c1_ts_tz from t3 where extract(year from c1_ts_tz) = 2024
----
logical_plan
01)Filter: t3.c1_ts_tz >= TimestampNanosecond(1704085200000000000, Some("America/New_York")) AND t3.c1_ts_tz < TimestampNanosecond(1735707600000000000, Some("America/New_York"))
02)--TableScan: t3 projection=[c1_ts_tz]
physical_plan
01)FilterExec: c1_ts_tz@0 >= 1704085200000000000 AND c1_ts_tz@0 < 1735707600000000000
02)--DataSourceExec: partitions=1, partition_sizes=[1]

statement ok
RESET datafusion.execution.time_zone;

# Test non-Int32 rhs argument

query D
select c from t1 where extract(year from c) = cast(2024 as bigint);
----
2024-01-01

query TT
explain select c from t1 where extract (year from c) = cast(2024 as bigint)
----
logical_plan
01)Filter: t1.c >= Date32("2024-01-01") AND t1.c < Date32("2025-01-01")
02)--TableScan: t1 projection=[c]
physical_plan
01)FilterExec: c@0 >= 2024-01-01 AND c@0 < 2025-01-01
02)--DataSourceExec: partitions=1, partition_sizes=[1]
