<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Custom Table Provider &#8212; Apache DataFusion  documentation</title>
    
    <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
  
    
    <link rel="stylesheet"
      href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">
  
    
      
  
    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/pydata-sphinx-theme.css?v=1140d252" />
    <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css?v=c6d785ac" />
    
    <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  
    <script src="../_static/documentation_options.js?v=8a448e45"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Table Constraint Enforcement" href="table-constraints.html" />
    <link rel="prev" title="Spark Compatible Functions" href="functions/spark.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    


    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items">

<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
    <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  ASF Links
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference external" href="https://apache.org">
   Apache Software Foundation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://www.apache.org/licenses/">
   License
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://www.apache.org/foundation/sponsorship.html">
   Donate
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://www.apache.org/foundation/thanks.html">
   Thanks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://www.apache.org/security/">
   Security
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Links
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference external" href="https://github.com/apache/datafusion">
   GitHub and Issue Tracker
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://crates.io/crates/datafusion">
   crates.io
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://docs.rs/datafusion/latest/datafusion/">
   API Docs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://datafusion.apache.org/blog/">
   Blog
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://github.com/apache/datafusion/blob/main/CODE_OF_CONDUCT.md">
   Code of conduct
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../download.html">
   Download
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  User Guide
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../user-guide/introduction.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../user-guide/example-usage.html">
   Example Usage
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../user-guide/features.html">
   Features
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../user-guide/concepts-readings-events.html">
   Concepts, Readings, Events
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../user-guide/crate-configuration.html">
   Crate Configuration
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../user-guide/cli/index.html">
   DataFusion CLI
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/cli/overview.html">
     Overview
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/cli/installation.html">
     Installation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/cli/usage.html">
     Usage
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/cli/datasources.html">
     Local Files / Directories
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../user-guide/dataframe.html">
   DataFrame API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../user-guide/expressions.html">
   Expression API
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../user-guide/sql/index.html">
   SQL Reference
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/data_types.html">
     Data Types
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/select.html">
     SELECT syntax
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/subqueries.html">
     Subqueries
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/ddl.html">
     DDL
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/dml.html">
     DML
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/explain.html">
     EXPLAIN
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/information_schema.html">
     Information Schema
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/operators.html">
     Operators and Literals
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/aggregate_functions.html">
     Aggregate Functions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/window_functions.html">
     Window Functions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/scalar_functions.html">
     Scalar Functions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/special_functions.html">
     Special Functions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/format_options.html">
     Format Options
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/prepared_statements.html">
     Prepared Statements
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../user-guide/configs.html">
   Configuration Settings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../user-guide/explain-usage.html">
   Reading Explain Plans
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../user-guide/faq.html">
   Frequently Asked Questions
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Library User Guide
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="index.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="upgrading.html">
   Upgrade Guides
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="extensions.html">
   Extensions List
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="using-the-sql-api.html">
   Using the SQL API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="working-with-exprs.html">
   Working with
   <code class="docutils literal notranslate">
    <span class="pre">
     Expr
    </span>
   </code>
   s
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="using-the-dataframe-api.html">
   Using the DataFrame API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="building-logical-plans.html">
   Building Logical Plans
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="catalogs.html">
   Catalogs, Schemas, and Tables
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="functions/index.html">
   Functions
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="functions/adding-udfs.html">
     Adding User Defined Functions: Scalar/Window/Aggregate/Table Functions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="functions/spark.html">
     Spark Compatible Functions
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Custom Table Provider
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="table-constraints.html">
   Table Constraint Enforcement
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="extending-operators.html">
   Extending DataFusion’s operators: custom LogicalPlan and Execution Plans
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="profiling.html">
   Profiling Cookbook
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="query-optimizer.html">
   DataFusion Query Optimizer
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Contributor Guide
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/index.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/communication.html">
   Communication
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/development_environment.html">
   Development Environment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/architecture.html">
   Architecture
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/testing.html">
   Testing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/api-health.html">
   API health policy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/howtos.html">
   HOWTOs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/roadmap.html">
   Roadmap
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/governance.html">
   Governance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/inviting.html">
   Inviting New Committers and PMC Members
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../contributor-guide/specification/index.html">
   Specifications
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../contributor-guide/specification/invariants.html">
     Invariants
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../contributor-guide/specification/output-field-name-semantic.html">
     Output field name semantics
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/gsoc_application_guidelines.html">
   GSoC Application Guidelines
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/gsoc_project_ideas.html">
   GSoC Project Ideas
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  DataFusion Subprojects
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference external" href="https://arrow.apache.org/ballista/">
   DataFusion Ballista
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://datafusion.apache.org/comet/">
   DataFusion Comet
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://datafusion.apache.org/python/">
   DataFusion Python
  </a>
 </li>
</ul>

    
  </div>

  <a class="navbar-brand" href="../index.html">
    <img src="../_static/images/2x_bgwhite_original.png" class="logo" alt="logo">
  </a>
</nav>

              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#table-provider-and-scan">
   Table Provider and Scan
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#scan">
     Scan
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#execution-plan">
       Execution Plan
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#scan-revisited">
       Scan Revisited
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#additional-tableprovider-methods">
         Additional
         <code class="docutils literal notranslate">
          <span class="pre">
           TableProvider
          </span>
         </code>
         Methods
        </a>
        <ul class="nav section-nav flex-column">
         <li class="toc-h6 nav-item toc-entry">
          <a class="reference internal nav-link" href="#supports-filters-pushdown">
           <code class="docutils literal notranslate">
            <span class="pre">
             supports_filters_pushdown
            </span>
           </code>
          </a>
         </li>
        </ul>
       </li>
      </ul>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-the-custom-table-provider">
   Using the Custom Table Provider
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#recap">
   Recap
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#next-steps">
   Next Steps
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                

<div class="tocsection editthispage">
    <a href="https://github.com/apache/arrow-datafusion/edit/main/docs/source/library-user-guide/custom-table-providers.md">
        <i class="fas fa-pencil-alt"></i> Edit this page
    </a>
</div>

              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <!---
  Licensed to the Apache Software Foundation (ASF) under one
  or more contributor license agreements.  See the NOTICE file
  distributed with this work for additional information
  regarding copyright ownership.  The ASF licenses this file
  to you under the Apache License, Version 2.0 (the
  "License"); you may not use this file except in compliance
  with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing,
  software distributed under the License is distributed on an
  "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  KIND, either express or implied.  See the License for the
  specific language governing permissions and limitations
  under the License.
-->
<section id="custom-table-provider">
<h1>Custom Table Provider<a class="headerlink" href="#custom-table-provider" title="Link to this heading">¶</a></h1>
<p>Like other areas of DataFusion, you extend DataFusion’s functionality by implementing a trait. The <a class="reference external" href="https://docs.rs/datafusion/latest/datafusion/datasource/trait.TableProvider.html"><code class="docutils literal notranslate"><span class="pre">TableProvider</span></code></a> and associated traits allow you to implement a custom table provider, i.e. use DataFusion’s other functionality with your custom data source.</p>
<p>This section describes how to create a <a class="reference external" href="https://docs.rs/datafusion/latest/datafusion/datasource/trait.TableProvider.html"><code class="docutils literal notranslate"><span class="pre">TableProvider</span></code></a> and how to configure DataFusion to use it for reading.</p>
<p>For details on how table constraints such as primary keys or unique
constraints are handled, see <a class="reference internal" href="table-constraints.html"><span class="std std-doc">Table Constraint Enforcement</span></a>.</p>
<section id="table-provider-and-scan">
<h2>Table Provider and Scan<a class="headerlink" href="#table-provider-and-scan" title="Link to this heading">¶</a></h2>
<p>The <a class="reference external" href="https://docs.rs/datafusion/latest/datafusion/datasource/trait.TableProvider.html#tymethod.scan"><code class="docutils literal notranslate"><span class="pre">TableProvider::scan</span></code></a> method reads data from the table and is likely the most important. It returns an <a class="reference external" href="https://docs.rs/datafusion/latest/datafusion/physical_plan/trait.ExecutionPlan.html"><code class="docutils literal notranslate"><span class="pre">ExecutionPlan</span></code></a> that DataFusion will use to read the actual data during execution of the query. The <a class="reference external" href="https://docs.rs/datafusion/latest/datafusion/datasource/trait.TableProvider.html#tymethod.insert_into"><code class="docutils literal notranslate"><span class="pre">TableProvider::insert_into</span></code></a> method is used to <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> data into the table.</p>
<section id="scan">
<h3>Scan<a class="headerlink" href="#scan" title="Link to this heading">¶</a></h3>
<p>As mentioned, <a class="reference external" href="https://docs.rs/datafusion/latest/datafusion/datasource/trait.TableProvider.html#tymethod.scan"><code class="docutils literal notranslate"><span class="pre">TableProvider::scan</span></code></a> returns an execution plan, and in particular a <code class="docutils literal notranslate"><span class="pre">Result&lt;Arc&lt;dyn</span> <span class="pre">ExecutionPlan&gt;&gt;</span></code>. The core of this is returning something that can be dynamically dispatched to an <code class="docutils literal notranslate"><span class="pre">ExecutionPlan</span></code>. And as per the general DataFusion idea, we’ll need to implement it.</p>
<section id="execution-plan">
<h4>Execution Plan<a class="headerlink" href="#execution-plan" title="Link to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">ExecutionPlan</span></code> trait at its core is a way to get a stream of batches. The aptly-named <code class="docutils literal notranslate"><span class="pre">execute</span></code> method returns a <code class="docutils literal notranslate"><span class="pre">Result&lt;SendableRecordBatchStream&gt;</span></code>, which should be a stream of <code class="docutils literal notranslate"><span class="pre">RecordBatch</span></code>es that can be sent across threads, and has a schema that matches the data to be contained in those batches.</p>
<p>There are many different types of <code class="docutils literal notranslate"><span class="pre">SendableRecordBatchStream</span></code> implemented in DataFusion – you can use a pre existing one, such as <code class="docutils literal notranslate"><span class="pre">MemoryStream</span></code> (if your <code class="docutils literal notranslate"><span class="pre">RecordBatch</span></code>es are all in memory) or implement your own custom logic, depending on your usecase.</p>
<p>Looking at the full example below:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">any</span><span class="p">::</span><span class="n">Any</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">sync</span><span class="p">::{</span><span class="n">Arc</span><span class="p">,</span><span class="w"> </span><span class="n">Mutex</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">collections</span><span class="p">::{</span><span class="n">BTreeMap</span><span class="p">,</span><span class="w"> </span><span class="n">HashMap</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">common</span><span class="p">::</span><span class="nb">Result</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">arrow</span><span class="p">::</span><span class="n">datatypes</span><span class="p">::{</span><span class="n">DataType</span><span class="p">,</span><span class="w"> </span><span class="n">Field</span><span class="p">,</span><span class="w"> </span><span class="n">Schema</span><span class="p">,</span><span class="w"> </span><span class="n">SchemaRef</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">physical_plan</span><span class="p">::</span><span class="n">expressions</span><span class="p">::</span><span class="n">PhysicalSortExpr</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">physical_plan</span><span class="p">::{</span>
<span class="w">    </span><span class="n">ExecutionPlan</span><span class="p">,</span><span class="w"> </span><span class="n">SendableRecordBatchStream</span><span class="p">,</span><span class="w"> </span><span class="n">DisplayAs</span><span class="p">,</span><span class="w"> </span><span class="n">DisplayFormatType</span><span class="p">,</span>
<span class="w">    </span><span class="n">Statistics</span><span class="p">,</span><span class="w"> </span><span class="n">PlanProperties</span>
<span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">execution</span><span class="p">::</span><span class="n">context</span><span class="p">::</span><span class="n">TaskContext</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">arrow</span><span class="p">::</span><span class="n">array</span><span class="p">::{</span><span class="n">UInt64Builder</span><span class="p">,</span><span class="w"> </span><span class="n">UInt8Builder</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">physical_plan</span><span class="p">::</span><span class="n">memory</span><span class="p">::</span><span class="n">MemoryStream</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">arrow</span><span class="p">::</span><span class="n">record_batch</span><span class="p">::</span><span class="n">RecordBatch</span><span class="p">;</span>

<span class="sd">/// A User, with an id and a bank account</span>
<span class="cp">#[derive(Clone, Debug)]</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">User</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="n">bank_account</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="p">}</span>

<span class="sd">/// A custom datasource, used to represent a datastore with a single index</span>
<span class="cp">#[derive(Clone, Debug)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">CustomDataSource</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">inner</span><span class="p">:</span><span class="w"> </span><span class="nc">Arc</span><span class="o">&lt;</span><span class="n">Mutex</span><span class="o">&lt;</span><span class="n">CustomDataSourceInner</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug)]</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">CustomDataSourceInner</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="nc">HashMap</span><span class="o">&lt;</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">bank_account_index</span><span class="p">:</span><span class="w"> </span><span class="nc">BTreeMap</span><span class="o">&lt;</span><span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug)]</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">CustomExec</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">db</span><span class="p">:</span><span class="w"> </span><span class="nc">CustomDataSource</span><span class="p">,</span>
<span class="w">    </span><span class="n">projected_schema</span><span class="p">:</span><span class="w"> </span><span class="nc">SchemaRef</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">DisplayAs</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">CustomExec</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">fmt_as</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">_t</span><span class="p">:</span><span class="w"> </span><span class="nc">DisplayFormatType</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">Formatter</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">std</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="nb">Result</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">write!</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;CustomExec&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">ExecutionPlan</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">CustomExec</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s">&quot;CustomExec&quot;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">as_any</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">dyn</span><span class="w"> </span><span class="n">Any</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">schema</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">SchemaRef</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">projected_schema</span><span class="p">.</span><span class="n">clone</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>


<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">properties</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">PlanProperties</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">unreachable!</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">children</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;&amp;</span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">ExecutionPlan</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Vec</span><span class="p">::</span><span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">with_new_children</span><span class="p">(</span>
<span class="w">        </span><span class="bp">self</span><span class="p">:</span><span class="w"> </span><span class="nc">Arc</span><span class="o">&lt;</span><span class="bp">Self</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="n">_</span><span class="p">:</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">ExecutionPlan</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">ExecutionPlan</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">_partition</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">        </span><span class="n">_context</span><span class="p">:</span><span class="w"> </span><span class="nc">Arc</span><span class="o">&lt;</span><span class="n">TaskContext</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">SendableRecordBatchStream</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">users</span><span class="p">:</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">lock</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">            </span><span class="n">db</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">values</span><span class="p">().</span><span class="n">cloned</span><span class="p">().</span><span class="n">collect</span><span class="p">()</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">id_array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UInt8Builder</span><span class="p">::</span><span class="n">with_capacity</span><span class="p">(</span><span class="n">users</span><span class="p">.</span><span class="n">len</span><span class="p">());</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">account_array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UInt64Builder</span><span class="p">::</span><span class="n">with_capacity</span><span class="p">(</span><span class="n">users</span><span class="p">.</span><span class="n">len</span><span class="p">());</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">id_array</span><span class="p">.</span><span class="n">append_value</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
<span class="w">            </span><span class="n">account_array</span><span class="p">.</span><span class="n">append_value</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">bank_account</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="nb">Box</span><span class="p">::</span><span class="n">pin</span><span class="p">(</span><span class="n">MemoryStream</span><span class="p">::</span><span class="n">try_new</span><span class="p">(</span>
<span class="w">            </span><span class="fm">vec!</span><span class="p">[</span><span class="n">RecordBatch</span><span class="p">::</span><span class="n">try_new</span><span class="p">(</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">projected_schema</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">                </span><span class="fm">vec!</span><span class="p">[</span>
<span class="w">                    </span><span class="n">Arc</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">id_array</span><span class="p">.</span><span class="n">finish</span><span class="p">()),</span>
<span class="w">                    </span><span class="n">Arc</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">account_array</span><span class="p">.</span><span class="n">finish</span><span class="p">()),</span>
<span class="w">                </span><span class="p">],</span>
<span class="w">            </span><span class="p">)</span><span class="o">?</span><span class="p">],</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">schema</span><span class="p">(),</span>
<span class="w">            </span><span class="nb">None</span><span class="p">,</span>
<span class="w">        </span><span class="p">)</span><span class="o">?</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This <code class="docutils literal notranslate"><span class="pre">execute</span></code> method:</p>
<ol class="arabic simple">
<li><p>Gets the users from the database</p></li>
<li><p>Constructs the individual output arrays (columns)</p></li>
<li><p>Returns a <code class="docutils literal notranslate"><span class="pre">MemoryStream</span></code> of a single <code class="docutils literal notranslate"><span class="pre">RecordBatch</span></code> with the arrays</p></li>
</ol>
<p>I.e. returns the “physical” data. For other examples, refer to the <a class="reference external" href="https://github.com/apache/datafusion/blob/a5e86fae3baadbd99f8fd0df83f45fde22f7b0c6/datafusion/core/src/datasource/physical_plan/csv.rs#L57-L70"><code class="docutils literal notranslate"><span class="pre">CsvSource</span></code></a> and <a class="reference external" href="https://github.com/apache/datafusion/blob/a5e86fae3baadbd99f8fd0df83f45fde22f7b0c6/datafusion/core/src/datasource/physical_plan/parquet.rs#L77-L104"><code class="docutils literal notranslate"><span class="pre">ParquetSource</span></code></a> for more complex implementations.</p>
<p>With the <code class="docutils literal notranslate"><span class="pre">ExecutionPlan</span></code> implemented, we can now implement the <code class="docutils literal notranslate"><span class="pre">scan</span></code> method of the <code class="docutils literal notranslate"><span class="pre">TableProvider</span></code>.</p>
</section>
<section id="scan-revisited">
<h4>Scan Revisited<a class="headerlink" href="#scan-revisited" title="Link to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">scan</span></code> method of the <code class="docutils literal notranslate"><span class="pre">TableProvider</span></code> returns a <code class="docutils literal notranslate"><span class="pre">Result&lt;Arc&lt;dyn</span> <span class="pre">ExecutionPlan&gt;&gt;</span></code>. We can use the <code class="docutils literal notranslate"><span class="pre">Arc</span></code> to return a reference-counted pointer to the <code class="docutils literal notranslate"><span class="pre">ExecutionPlan</span></code> we implemented. In the example, this is done by:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">async_trait</span><span class="p">::</span><span class="n">async_trait</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">logical_expr</span><span class="p">::</span><span class="n">expr</span><span class="p">::</span><span class="n">Expr</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">datasource</span><span class="p">::{</span><span class="n">TableProvider</span><span class="p">,</span><span class="w"> </span><span class="n">TableType</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">physical_plan</span><span class="p">::</span><span class="n">project_schema</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">catalog</span><span class="p">::</span><span class="n">Session</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">CustomExec</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">new</span><span class="p">(</span>
<span class="w">        </span><span class="n">projections</span><span class="p">:</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="n">schema</span><span class="p">:</span><span class="w"> </span><span class="nc">SchemaRef</span><span class="p">,</span>
<span class="w">        </span><span class="n">db</span><span class="p">:</span><span class="w"> </span><span class="nc">CustomDataSource</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">projected_schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">project_schema</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schema</span><span class="p">,</span><span class="w"> </span><span class="n">projections</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">db</span><span class="p">,</span>
<span class="w">            </span><span class="n">projected_schema</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">CustomDataSource</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">create_physical_plan</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">projections</span><span class="p">:</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="n">schema</span><span class="p">:</span><span class="w"> </span><span class="nc">SchemaRef</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">ExecutionPlan</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Arc</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">CustomExec</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">projections</span><span class="p">,</span><span class="w"> </span><span class="n">schema</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">clone</span><span class="p">())))</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[async_trait]</span>
<span class="k">impl</span><span class="w"> </span><span class="n">TableProvider</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">CustomDataSource</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">as_any</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">dyn</span><span class="w"> </span><span class="n">Any</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">schema</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">SchemaRef</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">SchemaRef</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">Schema</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span>
<span class="w">            </span><span class="n">Field</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DataType</span><span class="p">::</span><span class="n">UInt8</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">),</span>
<span class="w">            </span><span class="n">Field</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="s">&quot;bank_account&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DataType</span><span class="p">::</span><span class="n">UInt64</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">),</span>
<span class="w">        </span><span class="p">]))</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">table_type</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">TableType</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">TableType</span><span class="p">::</span><span class="n">Base</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">scan</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">_state</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">dyn</span><span class="w"> </span><span class="n">Session</span><span class="p">,</span>
<span class="w">        </span><span class="n">projection</span><span class="p">:</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="c1">// filters and limit can be used here to inject some push-down operations if needed</span>
<span class="w">        </span><span class="n">_filters</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="p">[</span><span class="n">Expr</span><span class="p">],</span>
<span class="w">        </span><span class="n">_limit</span><span class="p">:</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">ExecutionPlan</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">create_physical_plan</span><span class="p">(</span><span class="n">projection</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">schema</span><span class="p">()).</span><span class="k">await</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>With this, and the implementation of the omitted methods, we can now use the <code class="docutils literal notranslate"><span class="pre">CustomDataSource</span></code> as a <code class="docutils literal notranslate"><span class="pre">TableProvider</span></code> in DataFusion.</p>
<section id="additional-tableprovider-methods">
<h5>Additional <code class="docutils literal notranslate"><span class="pre">TableProvider</span></code> Methods<a class="headerlink" href="#additional-tableprovider-methods" title="Link to this heading">¶</a></h5>
<p><code class="docutils literal notranslate"><span class="pre">scan</span></code> has no default implementation, so it needed to be written. There are other methods on the <code class="docutils literal notranslate"><span class="pre">TableProvider</span></code> that have default implementations, but can be overridden if needed to provide additional functionality.</p>
<section id="supports-filters-pushdown">
<h6><code class="docutils literal notranslate"><span class="pre">supports_filters_pushdown</span></code><a class="headerlink" href="#supports-filters-pushdown" title="Link to this heading">¶</a></h6>
<p>The <code class="docutils literal notranslate"><span class="pre">supports_filters_pushdown</span></code> method can be overridden to indicate which filter expressions support being pushed down to the data source and within that the specificity of the pushdown.</p>
<p>This returns a <code class="docutils literal notranslate"><span class="pre">Vec</span></code> of <code class="docutils literal notranslate"><span class="pre">TableProviderFilterPushDown</span></code> enums where each enum represents a filter that can be pushed down. The <code class="docutils literal notranslate"><span class="pre">TableProviderFilterPushDown</span></code> enum has three variants:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">TableProviderFilterPushDown::Unsupported</span></code> - the filter cannot be pushed down</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TableProviderFilterPushDown::Exact</span></code> - the filter can be pushed down and the data source can guarantee that the filter will be applied completely to all rows. This is the highest performance option.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TableProviderFilterPushDown::Inexact</span></code> - the filter can be pushed down, but the data source cannot guarantee that the filter will be applied to all rows. DataFusion will apply <code class="docutils literal notranslate"><span class="pre">Inexact</span></code> filters again after the scan to ensure correctness.</p></li>
</ul>
<p>For filters that can be pushed down, they’ll be passed to the <code class="docutils literal notranslate"><span class="pre">scan</span></code> method as the <code class="docutils literal notranslate"><span class="pre">filters</span></code> parameter and they can be made use of there.</p>
</section>
</section>
</section>
</section>
</section>
<section id="using-the-custom-table-provider">
<h2>Using the Custom Table Provider<a class="headerlink" href="#using-the-custom-table-provider" title="Link to this heading">¶</a></h2>
<p>In order to use the custom table provider, we need to register it with DataFusion. This is done by creating a <code class="docutils literal notranslate"><span class="pre">TableProvider</span></code> and registering it with the <code class="docutils literal notranslate"><span class="pre">SessionContext</span></code>.</p>
<p>This will allow you to use the custom table provider in DataFusion. For example, you could use it in a SQL query to get a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">execution</span><span class="p">::</span><span class="n">context</span><span class="p">::</span><span class="n">SessionContext</span><span class="p">;</span>

<span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SessionContext</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">custom_table_provider</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CustomDataSource</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">inner</span><span class="p">:</span><span class="w"> </span><span class="nc">Arc</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">Mutex</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">CustomDataSourceInner</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="nb">Default</span><span class="p">::</span><span class="n">default</span><span class="p">(),</span>
<span class="w">            </span><span class="n">bank_account_index</span><span class="p">:</span><span class="w"> </span><span class="nb">Default</span><span class="p">::</span><span class="n">default</span><span class="p">(),</span>
<span class="w">        </span><span class="p">})),</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">register_table</span><span class="p">(</span><span class="s">&quot;customers&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Arc</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">custom_table_provider</span><span class="p">));</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">sql</span><span class="p">(</span><span class="s">&quot;SELECT id, bank_account FROM customers&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="recap">
<h2>Recap<a class="headerlink" href="#recap" title="Link to this heading">¶</a></h2>
<p>To recap, in order to implement a custom table provider, you need to:</p>
<ol class="arabic simple">
<li><p>Implement the <code class="docutils literal notranslate"><span class="pre">TableProvider</span></code> trait</p></li>
<li><p>Implement the <code class="docutils literal notranslate"><span class="pre">ExecutionPlan</span></code> trait</p></li>
<li><p>Register the <code class="docutils literal notranslate"><span class="pre">TableProvider</span></code> with the <code class="docutils literal notranslate"><span class="pre">SessionContext</span></code></p></li>
</ol>
</section>
<section id="next-steps">
<h2>Next Steps<a class="headerlink" href="#next-steps" title="Link to this heading">¶</a></h2>
<p>As mentioned the <a class="reference external" href="https://github.com/apache/datafusion/blob/a5e86fae3baadbd99f8fd0df83f45fde22f7b0c6/datafusion/core/src/datasource/physical_plan/csv.rs#L57-L70">csv</a> and <a class="reference external" href="https://github.com/apache/datafusion/blob/a5e86fae3baadbd99f8fd0df83f45fde22f7b0c6/datafusion/core/src/datasource/physical_plan/parquet.rs#L77-L104">parquet</a> implementations are good examples of how to implement a <code class="docutils literal notranslate"><span class="pre">TableProvider</span></code>. The <a class="reference external" href="https://github.com/apache/datafusion/blob/a5e86fae3baadbd99f8fd0df83f45fde22f7b0c6/datafusion-examples/examples/custom_datasource.rs#L214C1-L276">example in this repo</a> is a good example of how to implement a <code class="docutils literal notranslate"><span class="pre">TableProvider</span></code> that uses a custom data source.</p>
<p>More abstractly, see the following traits for more information on how to implement a custom <code class="docutils literal notranslate"><span class="pre">TableProvider</span></code> for a file format:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">FileOpener</span></code> - a trait for opening a file and inferring the schema</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FileFormat</span></code> - a trait for reading a file format</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ListingTableProvider</span></code> - a useful trait for implementing a <code class="docutils literal notranslate"><span class="pre">TableProvider</span></code> that lists files in a directory</p></li>
</ul>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="functions/spark.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Spark Compatible Functions</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="table-constraints.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Table Constraint Enforcement</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
    <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
  
<!-- Based on pydata_sphinx_theme/footer.html -->
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2019-2025, Apache Software Foundation.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 8.2.3.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p>Apache DataFusion, Apache, the Apache feather logo, and the Apache DataFusion project logo</p>
      <p>are either registered trademarks or trademarks of The Apache Software Foundation in the United States and other countries.</p>
    </div>
  </div>
</footer>


  </body>
</html>