<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Working with Exprs &#8212; Apache DataFusion  documentation</title>
    
    <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
  
    
    <link rel="stylesheet"
      href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">
  
    
      
  
    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/pydata-sphinx-theme.css?v=1140d252" />
    <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css?v=c6d785ac" />
    
    <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  
    <script src="../_static/documentation_options.js?v=8a448e45"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Using the DataFrame API" href="using-the-dataframe-api.html" />
    <link rel="prev" title="Using the SQL API" href="using-the-sql-api.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    


    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items">

<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
    <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  ASF Links
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference external" href="https://apache.org">
   Apache Software Foundation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://www.apache.org/licenses/">
   License
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://www.apache.org/foundation/sponsorship.html">
   Donate
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://www.apache.org/foundation/thanks.html">
   Thanks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://www.apache.org/security/">
   Security
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Links
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference external" href="https://github.com/apache/datafusion">
   GitHub and Issue Tracker
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://crates.io/crates/datafusion">
   crates.io
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://docs.rs/datafusion/latest/datafusion/">
   API Docs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://datafusion.apache.org/blog/">
   Blog
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://github.com/apache/datafusion/blob/main/CODE_OF_CONDUCT.md">
   Code of conduct
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../download.html">
   Download
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  User Guide
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../user-guide/introduction.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../user-guide/example-usage.html">
   Example Usage
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../user-guide/features.html">
   Features
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../user-guide/concepts-readings-events.html">
   Concepts, Readings, Events
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../user-guide/crate-configuration.html">
   Crate Configuration
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../user-guide/cli/index.html">
   DataFusion CLI
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/cli/overview.html">
     Overview
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/cli/installation.html">
     Installation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/cli/usage.html">
     Usage
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/cli/datasources.html">
     Local Files / Directories
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../user-guide/dataframe.html">
   DataFrame API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../user-guide/expressions.html">
   Expression API
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../user-guide/sql/index.html">
   SQL Reference
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/data_types.html">
     Data Types
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/select.html">
     SELECT syntax
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/subqueries.html">
     Subqueries
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/ddl.html">
     DDL
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/dml.html">
     DML
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/explain.html">
     EXPLAIN
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/information_schema.html">
     Information Schema
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/operators.html">
     Operators and Literals
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/aggregate_functions.html">
     Aggregate Functions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/window_functions.html">
     Window Functions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/scalar_functions.html">
     Scalar Functions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/special_functions.html">
     Special Functions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/format_options.html">
     Format Options
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../user-guide/sql/prepared_statements.html">
     Prepared Statements
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../user-guide/configs.html">
   Configuration Settings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../user-guide/explain-usage.html">
   Reading Explain Plans
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../user-guide/faq.html">
   Frequently Asked Questions
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Library User Guide
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="index.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="upgrading.html">
   Upgrade Guides
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="extensions.html">
   Extensions List
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="using-the-sql-api.html">
   Using the SQL API
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Working with
   <code class="docutils literal notranslate">
    <span class="pre">
     Expr
    </span>
   </code>
   s
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="using-the-dataframe-api.html">
   Using the DataFrame API
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="building-logical-plans.html">
   Building Logical Plans
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="catalogs.html">
   Catalogs, Schemas, and Tables
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="functions/index.html">
   Functions
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="functions/adding-udfs.html">
     Adding User Defined Functions: Scalar/Window/Aggregate/Table Functions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="functions/spark.html">
     Spark Compatible Functions
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="custom-table-providers.html">
   Custom Table Provider
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="table-constraints.html">
   Table Constraint Enforcement
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="extending-operators.html">
   Extending DataFusion’s operators: custom LogicalPlan and Execution Plans
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="profiling.html">
   Profiling Cookbook
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="query-optimizer.html">
   DataFusion Query Optimizer
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Contributor Guide
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/index.html">
   Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/communication.html">
   Communication
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/development_environment.html">
   Development Environment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/architecture.html">
   Architecture
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/testing.html">
   Testing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/api-health.html">
   API health policy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/howtos.html">
   HOWTOs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/roadmap.html">
   Roadmap
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/governance.html">
   Governance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/inviting.html">
   Inviting New Committers and PMC Members
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../contributor-guide/specification/index.html">
   Specifications
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../contributor-guide/specification/invariants.html">
     Invariants
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../contributor-guide/specification/output-field-name-semantic.html">
     Output field name semantics
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/gsoc_application_guidelines.html">
   GSoC Application Guidelines
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributor-guide/gsoc_project_ideas.html">
   GSoC Project Ideas
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  DataFusion Subprojects
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference external" href="https://arrow.apache.org/ballista/">
   DataFusion Ballista
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://datafusion.apache.org/comet/">
   DataFusion Comet
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://datafusion.apache.org/python/">
   DataFusion Python
  </a>
 </li>
</ul>

    
  </div>

  <a class="navbar-brand" href="../index.html">
    <img src="../_static/images/2x_bgwhite_original.png" class="logo" alt="logo">
  </a>
</nav>

              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#arrow-schema-and-datafusion-dfschema">
   Arrow Schema and DataFusion DFSchema
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#difference-between-schema-and-dfschema">
     Difference between Schema and DFSchema
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#how-to-convert-between-schema-and-dfschema">
     How to convert between Schema and DFSchema
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#creating-and-evaluating-exprs">
   Creating and Evaluating
   <code class="docutils literal notranslate">
    <span class="pre">
     Expr
    </span>
   </code>
   s
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-scalar-udf-example">
   A Scalar UDF Example
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#rewriting-exprs">
   Rewriting
   <code class="docutils literal notranslate">
    <span class="pre">
     Expr
    </span>
   </code>
   s
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#rewriting-with-transform">
     Rewriting with
     <code class="docutils literal notranslate">
      <span class="pre">
       transform
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#creating-an-optimizerrule">
     Creating an
     <code class="docutils literal notranslate">
      <span class="pre">
       OptimizerRule
      </span>
     </code>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#testing-the-rule">
   Testing the Rule
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#getting-the-data-type-of-the-expression">
   Getting the data type of the expression
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusion">
   Conclusion
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                

<div class="tocsection editthispage">
    <a href="https://github.com/apache/arrow-datafusion/edit/main/docs/source/library-user-guide/working-with-exprs.md">
        <i class="fas fa-pencil-alt"></i> Edit this page
    </a>
</div>

              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <!---
  Licensed to the Apache Software Foundation (ASF) under one
  or more contributor license agreements.  See the NOTICE file
  distributed with this work for additional information
  regarding copyright ownership.  The ASF licenses this file
  to you under the Apache License, Version 2.0 (the
  "License"); you may not use this file except in compliance
  with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing,
  software distributed under the License is distributed on an
  "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  KIND, either express or implied.  See the License for the
  specific language governing permissions and limitations
  under the License.
-->
<section id="working-with-exprs">
<h1>Working with <code class="docutils literal notranslate"><span class="pre">Expr</span></code>s<a class="headerlink" href="#working-with-exprs" title="Link to this heading">¶</a></h1>
<!-- https://github.com/apache/datafusion/issues/7304 -->
<p><code class="docutils literal notranslate"><span class="pre">Expr</span></code> is short for “expression”. It is a core abstraction in DataFusion for representing a computation, and follows the standard “expression tree” abstraction found in most compilers and databases.</p>
<p>For example, the SQL expression <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">+</span> <span class="pre">b</span></code> would be represented as an <code class="docutils literal notranslate"><span class="pre">Expr</span></code> with a <code class="docutils literal notranslate"><span class="pre">BinaryExpr</span></code> variant. A <code class="docutils literal notranslate"><span class="pre">BinaryExpr</span></code> has a left and right <code class="docutils literal notranslate"><span class="pre">Expr</span></code> and an operator.</p>
<p>As another example, the SQL expression <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">+</span> <span class="pre">b</span> <span class="pre">*</span> <span class="pre">c</span></code> would be represented as an <code class="docutils literal notranslate"><span class="pre">Expr</span></code> with a <code class="docutils literal notranslate"><span class="pre">BinaryExpr</span></code> variant. The left <code class="docutils literal notranslate"><span class="pre">Expr</span></code> would be <code class="docutils literal notranslate"><span class="pre">a</span></code> and the right <code class="docutils literal notranslate"><span class="pre">Expr</span></code> would be another <code class="docutils literal notranslate"><span class="pre">BinaryExpr</span></code> with a left <code class="docutils literal notranslate"><span class="pre">Expr</span></code> of <code class="docutils literal notranslate"><span class="pre">b</span></code> and a right <code class="docutils literal notranslate"><span class="pre">Expr</span></code> of <code class="docutils literal notranslate"><span class="pre">c</span></code>. As a classic expression tree, this would look like:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>            ┌────────────────────┐
            │     BinaryExpr     │
            │       op: +        │
            └────────────────────┘
                   ▲     ▲
           ┌───────┘     └────────────────┐
           │                              │
┌────────────────────┐         ┌────────────────────┐
│     Expr::Col      │         │     BinaryExpr     │
│       col: a       │         │       op: *        │
└────────────────────┘         └────────────────────┘
                                        ▲    ▲
                               ┌────────┘    └─────────┐
                               │                       │
                    ┌────────────────────┐  ┌────────────────────┐
                    │     Expr::Col      │  │     Expr::Col      │
                    │       col: b       │  │       col: c       │
                    └────────────────────┘  └────────────────────┘
</pre></div>
</div>
<p>As the writer of a library, you can use <code class="docutils literal notranslate"><span class="pre">Expr</span></code>s to represent computations that you want to perform. This guide will walk you through how to make your own scalar UDF as an <code class="docutils literal notranslate"><span class="pre">Expr</span></code> and how to rewrite <code class="docutils literal notranslate"><span class="pre">Expr</span></code>s to inline the simple UDF.</p>
<section id="arrow-schema-and-datafusion-dfschema">
<h2>Arrow Schema and DataFusion DFSchema<a class="headerlink" href="#arrow-schema-and-datafusion-dfschema" title="Link to this heading">¶</a></h2>
<p>Apache Arrow <code class="docutils literal notranslate"><span class="pre">Schema</span></code> provides a lightweight structure for defining data, and Apache Datafusion<code class="docutils literal notranslate"><span class="pre">DFSchema</span></code> extends it with extra information such as column qualifiers and functional dependencies. Column qualifiers are multi part path to the table e.g table, schema, catalog. Functional Dependency is the relationship between attributes(characteristics) of a table related to each other.</p>
<section id="difference-between-schema-and-dfschema">
<h3>Difference between Schema and DFSchema<a class="headerlink" href="#difference-between-schema-and-dfschema" title="Link to this heading">¶</a></h3>
<ul>
<li><p>Schema: A fundamental component of Apache Arrow, <code class="docutils literal notranslate"><span class="pre">Schema</span></code> defines a dataset’s structure, specifying column names and their data types.</p>
<blockquote>
<div><p>Please see <a class="reference external" href="https://docs.rs/arrow-schema/54.2.1/arrow_schema/struct.Schema.html">Struct Schema</a> for a detailed document of Arrow Schema.</p>
</div></blockquote>
</li>
<li><p>DFSchema: Extending <code class="docutils literal notranslate"><span class="pre">Schema</span></code>, <code class="docutils literal notranslate"><span class="pre">DFSchema</span></code> incorporates qualifiers such as table names, enabling it to carry additional context when required. This is particularly valuable for managing queries across multiple tables.</p>
<blockquote>
<div><p>Please see <a class="reference external" href="https://docs.rs/datafusion/latest/datafusion/common/struct.DFSchema.html">Struct DFSchema</a> for a detailed document of DFSchema.</p>
</div></blockquote>
</li>
</ul>
</section>
<section id="how-to-convert-between-schema-and-dfschema">
<h3>How to convert between Schema and DFSchema<a class="headerlink" href="#how-to-convert-between-schema-and-dfschema" title="Link to this heading">¶</a></h3>
<p>From Schema to DFSchema: Use <code class="docutils literal notranslate"><span class="pre">DFSchema::try_from_qualified_schema</span></code> with a table name and original schema, for detailed code example please see <a class="reference external" href="https://docs.rs/datafusion/latest/datafusion/common/struct.DFSchema.html#creating-qualified-schemas">creating-qualified-schemas</a>.</p>
<p>From DFSchema to Schema: Since the <code class="docutils literal notranslate"><span class="pre">Into</span></code> trait has been implemented for DFSchema to convert it into an Arrow Schema, for detailed code example please see <a class="reference external" href="https://docs.rs/datafusion/latest/datafusion/common/struct.DFSchema.html#converting-back-to-arrow-schema">converting-back-to-arrow-schema</a>.</p>
</section>
</section>
<section id="creating-and-evaluating-exprs">
<h2>Creating and Evaluating <code class="docutils literal notranslate"><span class="pre">Expr</span></code>s<a class="headerlink" href="#creating-and-evaluating-exprs" title="Link to this heading">¶</a></h2>
<p>Please see <a class="reference external" href="https://github.com/apache/datafusion/blob/main/datafusion-examples/examples/expr_api.rs">expr_api.rs</a> for well commented code for creating, evaluating, simplifying, and analyzing <code class="docutils literal notranslate"><span class="pre">Expr</span></code>s.</p>
</section>
<section id="a-scalar-udf-example">
<h2>A Scalar UDF Example<a class="headerlink" href="#a-scalar-udf-example" title="Link to this heading">¶</a></h2>
<p>We’ll use a <code class="docutils literal notranslate"><span class="pre">ScalarUDF</span></code> expression as our example. This necessitates implementing an actual UDF, and for ease we’ll use the same example from the <a class="reference internal" href="functions/adding-udfs.html"><span class="std std-doc">adding UDFs</span></a> guide.</p>
<p>So assuming you’ve written that function, you can use it to create an <code class="docutils literal notranslate"><span class="pre">Expr</span></code>:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">logical_expr</span><span class="p">::{</span><span class="n">Volatility</span><span class="p">,</span><span class="w"> </span><span class="n">create_udf</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">arrow</span><span class="p">::</span><span class="n">datatypes</span><span class="p">::</span><span class="n">DataType</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">logical_expr</span><span class="p">::{</span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">lit</span><span class="p">};</span>

<span class="kd">let</span><span class="w"> </span><span class="n">add_one_udf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_udf</span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;add_one&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="fm">vec!</span><span class="p">[</span><span class="n">DataType</span><span class="p">::</span><span class="n">Int64</span><span class="p">],</span>
<span class="w">    </span><span class="n">DataType</span><span class="p">::</span><span class="n">Int64</span><span class="p">,</span>
<span class="w">    </span><span class="n">Volatility</span><span class="p">::</span><span class="n">Immutable</span><span class="p">,</span>
<span class="w">    </span><span class="n">Arc</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">add_one</span><span class="p">),</span>
<span class="p">);</span>

<span class="c1">// make the expr `add_one(5)`</span>
<span class="kd">let</span><span class="w"> </span><span class="n">expr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">add_one_udf</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">lit</span><span class="p">(</span><span class="mi">5</span><span class="p">)]);</span>

<span class="c1">// make the expr `add_one(my_column)`</span>
<span class="kd">let</span><span class="w"> </span><span class="n">expr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">add_one_udf</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[</span><span class="n">col</span><span class="p">(</span><span class="s">&quot;my_column&quot;</span><span class="p">)]);</span>
</pre></div>
</div>
<p>If you’d like to learn more about <code class="docutils literal notranslate"><span class="pre">Expr</span></code>s, before we get into the details of creating and rewriting them, you can read the <a class="reference internal" href="../user-guide/expressions.html"><span class="std std-doc">expression user-guide</span></a>.</p>
</section>
<section id="rewriting-exprs">
<h2>Rewriting <code class="docutils literal notranslate"><span class="pre">Expr</span></code>s<a class="headerlink" href="#rewriting-exprs" title="Link to this heading">¶</a></h2>
<p>There are several examples of rewriting and working with <code class="docutils literal notranslate"><span class="pre">Exprs</span></code>:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/apache/datafusion/blob/main/datafusion-examples/examples/expr_api.rs">expr_api.rs</a></p></li>
<li><p><a class="reference external" href="https://github.com/apache/datafusion/blob/main/datafusion-examples/examples/analyzer_rule.rs">analyzer_rule.rs</a></p></li>
<li><p><a class="reference external" href="https://github.com/apache/datafusion/blob/main/datafusion-examples/examples/optimizer_rule.rs">optimizer_rule.rs</a></p></li>
</ul>
<p>Rewriting Expressions is the process of taking an <code class="docutils literal notranslate"><span class="pre">Expr</span></code> and transforming it into another <code class="docutils literal notranslate"><span class="pre">Expr</span></code>. This is useful for a number of reasons, including:</p>
<ul class="simple">
<li><p>Simplifying <code class="docutils literal notranslate"><span class="pre">Expr</span></code>s to make them easier to evaluate</p></li>
<li><p>Optimizing <code class="docutils literal notranslate"><span class="pre">Expr</span></code>s to make them faster to evaluate</p></li>
<li><p>Converting <code class="docutils literal notranslate"><span class="pre">Expr</span></code>s to other forms, e.g. converting a <code class="docutils literal notranslate"><span class="pre">BinaryExpr</span></code> to a <code class="docutils literal notranslate"><span class="pre">CastExpr</span></code></p></li>
</ul>
<p>In our example, we’ll use rewriting to update our <code class="docutils literal notranslate"><span class="pre">add_one</span></code> UDF, to be rewritten as a <code class="docutils literal notranslate"><span class="pre">BinaryExpr</span></code> with a <code class="docutils literal notranslate"><span class="pre">Literal</span></code> of 1. We’re effectively inlining the UDF.</p>
<section id="rewriting-with-transform">
<h3>Rewriting with <code class="docutils literal notranslate"><span class="pre">transform</span></code><a class="headerlink" href="#rewriting-with-transform" title="Link to this heading">¶</a></h3>
<p>To implement the inlining, we’ll need to write a function that takes an <code class="docutils literal notranslate"><span class="pre">Expr</span></code> and returns a <code class="docutils literal notranslate"><span class="pre">Result&lt;Expr&gt;</span></code>. If the expression is <em>not</em> to be rewritten <code class="docutils literal notranslate"><span class="pre">Transformed::no</span></code> is used to wrap the original <code class="docutils literal notranslate"><span class="pre">Expr</span></code>. If the expression <em>is</em> to be rewritten, <code class="docutils literal notranslate"><span class="pre">Transformed::yes</span></code> is used to wrap the new <code class="docutils literal notranslate"><span class="pre">Expr</span></code>.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">common</span><span class="p">::</span><span class="nb">Result</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">common</span><span class="p">::</span><span class="n">tree_node</span><span class="p">::{</span><span class="n">Transformed</span><span class="p">,</span><span class="w"> </span><span class="n">TreeNode</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">logical_expr</span><span class="p">::{</span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">lit</span><span class="p">,</span><span class="w"> </span><span class="n">Expr</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">logical_expr</span><span class="p">::{</span><span class="n">ScalarUDF</span><span class="p">};</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">rewrite_add_one</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span><span class="w"> </span><span class="nc">Expr</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Transformed</span><span class="o">&lt;</span><span class="n">Expr</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">expr</span><span class="p">.</span><span class="n">transform</span><span class="p">(</span><span class="o">&amp;|</span><span class="n">expr</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="k">match</span><span class="w"> </span><span class="n">expr</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Expr</span><span class="p">::</span><span class="n">ScalarFunction</span><span class="p">(</span><span class="n">scalar_func</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">scalar_func</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">inner</span><span class="p">().</span><span class="n">name</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;add_one&quot;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">input_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scalar_func</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">clone</span><span class="p">();</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">new_expression</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input_arg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">lit</span><span class="p">(</span><span class="mi">1</span><span class="k">i64</span><span class="p">);</span>

<span class="w">                </span><span class="n">Transformed</span><span class="p">::</span><span class="n">yes</span><span class="p">(</span><span class="n">new_expression</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Transformed</span><span class="p">::</span><span class="n">no</span><span class="p">(</span><span class="n">expr</span><span class="p">),</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="creating-an-optimizerrule">
<h3>Creating an <code class="docutils literal notranslate"><span class="pre">OptimizerRule</span></code><a class="headerlink" href="#creating-an-optimizerrule" title="Link to this heading">¶</a></h3>
<p>In DataFusion, an <code class="docutils literal notranslate"><span class="pre">OptimizerRule</span></code> is a trait that supports rewriting<code class="docutils literal notranslate"><span class="pre">Expr</span></code>s that appear in various parts of the <code class="docutils literal notranslate"><span class="pre">LogicalPlan</span></code>. It follows DataFusion’s general mantra of trait implementations to drive behavior.</p>
<p>We’ll call our rule <code class="docutils literal notranslate"><span class="pre">AddOneInliner</span></code> and implement the <code class="docutils literal notranslate"><span class="pre">OptimizerRule</span></code> trait. The <code class="docutils literal notranslate"><span class="pre">OptimizerRule</span></code> trait has two methods:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code> - returns the name of the rule</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">try_optimize</span></code> - takes a <code class="docutils literal notranslate"><span class="pre">LogicalPlan</span></code> and returns an <code class="docutils literal notranslate"><span class="pre">Option&lt;LogicalPlan&gt;</span></code>. If the rule is able to optimize the plan, it returns <code class="docutils literal notranslate"><span class="pre">Some(LogicalPlan)</span></code> with the optimized plan. If the rule is not able to optimize the plan, it returns <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p></li>
</ul>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">Arc</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">common</span><span class="p">::</span><span class="nb">Result</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">common</span><span class="p">::</span><span class="n">tree_node</span><span class="p">::{</span><span class="n">Transformed</span><span class="p">,</span><span class="w"> </span><span class="n">TreeNode</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">logical_expr</span><span class="p">::{</span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">lit</span><span class="p">,</span><span class="w"> </span><span class="n">Expr</span><span class="p">,</span><span class="w"> </span><span class="n">LogicalPlan</span><span class="p">,</span><span class="w"> </span><span class="n">LogicalPlanBuilder</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">optimizer</span><span class="p">::{</span><span class="n">OptimizerRule</span><span class="p">,</span><span class="w"> </span><span class="n">OptimizerConfig</span><span class="p">,</span><span class="w"> </span><span class="n">OptimizerContext</span><span class="p">,</span><span class="w"> </span><span class="n">Optimizer</span><span class="p">};</span>


<span class="cp">#[derive(Default, Debug)]</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">AddOneInliner</span><span class="w"> </span><span class="p">{}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">OptimizerRule</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">AddOneInliner</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s">&quot;add_one_inliner&quot;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">rewrite</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">plan</span><span class="p">:</span><span class="w"> </span><span class="nc">LogicalPlan</span><span class="p">,</span>
<span class="w">        </span><span class="n">_config</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">dyn</span><span class="w"> </span><span class="n">OptimizerConfig</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Transformed</span><span class="o">&lt;</span><span class="n">LogicalPlan</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Map over the expressions and rewrite them</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">new_expressions</span><span class="p">:</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Expr</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plan</span>
<span class="w">            </span><span class="p">.</span><span class="n">expressions</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">into_iter</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">expr</span><span class="o">|</span><span class="w"> </span><span class="n">rewrite_add_one</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="n">collect</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;&gt;&gt;</span><span class="p">()</span><span class="o">?</span><span class="w"> </span><span class="c1">// returns Vec&lt;Transformed&lt;Expr&gt;&gt;</span>
<span class="w">            </span><span class="p">.</span><span class="n">into_iter</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">transformed</span><span class="o">|</span><span class="w"> </span><span class="n">transformed</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">collect</span><span class="p">();</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">inputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plan</span><span class="p">.</span><span class="n">inputs</span><span class="p">().</span><span class="n">into_iter</span><span class="p">().</span><span class="n">cloned</span><span class="p">().</span><span class="n">collect</span><span class="p">::</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;&gt;</span><span class="p">();</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">plan</span><span class="p">:</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">LogicalPlan</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plan</span><span class="p">.</span><span class="n">with_new_exprs</span><span class="p">(</span><span class="n">new_expressions</span><span class="p">,</span><span class="w"> </span><span class="n">inputs</span><span class="p">);</span>

<span class="w">        </span><span class="n">plan</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">p</span><span class="o">|</span><span class="w"> </span><span class="n">Transformed</span><span class="p">::</span><span class="n">yes</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note the use of <code class="docutils literal notranslate"><span class="pre">rewrite_add_one</span></code> which is mapped over <code class="docutils literal notranslate"><span class="pre">plan.expressions()</span></code> to rewrite the expressions, then <code class="docutils literal notranslate"><span class="pre">plan.with_new_exprs</span></code> is used to create a new <code class="docutils literal notranslate"><span class="pre">LogicalPlan</span></code> with the rewritten expressions.</p>
<p>We’re almost there. Let’s just test our rule works properly.</p>
</section>
</section>
<section id="testing-the-rule">
<h2>Testing the Rule<a class="headerlink" href="#testing-the-rule" title="Link to this heading">¶</a></h2>
<p>Testing the rule is fairly simple, we can create a SessionState with our rule and then create a DataFrame and run a query. The logical plan will be optimized by our rule.</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">execution</span><span class="p">::</span><span class="n">context</span><span class="p">::</span><span class="n">SessionContext</span><span class="p">;</span>

<span class="cp">#[tokio::main]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SessionContext</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// ctx.add_optimizer_rule(Arc::new(AddOneInliner {}));</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">add_one_udf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_udf</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;add_one&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="fm">vec!</span><span class="p">[</span><span class="n">DataType</span><span class="p">::</span><span class="n">Int64</span><span class="p">],</span>
<span class="w">        </span><span class="n">DataType</span><span class="p">::</span><span class="n">Int64</span><span class="p">,</span>
<span class="w">        </span><span class="n">Volatility</span><span class="p">::</span><span class="n">Immutable</span><span class="p">,</span>
<span class="w">        </span><span class="n">Arc</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">add_one</span><span class="p">),</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="n">ctx</span><span class="p">.</span><span class="n">register_udf</span><span class="p">(</span><span class="n">add_one_udf</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sql</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;SELECT add_one(5) AS added_one&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// let plan = ctx.sql(sql).await?.into_unoptimized_plan().clone();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">plan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">sql</span><span class="p">(</span><span class="n">sql</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">.</span><span class="n">into_optimized_plan</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">r#&quot;Projection: Int64(6) AS added_one</span>
<span class="s">  EmptyRelation&quot;#</span><span class="p">;</span>

<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">plan</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"> </span><span class="n">expected</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This plan is optimized as:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Projection: add_one(Int64(5)) AS added_one
    -&gt; Projection: Int64(5) + Int64(1) AS added_one
        -&gt; Projection: Int64(6) AS added_one
</pre></div>
</div>
<p>I.e. the <code class="docutils literal notranslate"><span class="pre">add_one</span></code> UDF has been inlined into the projection.</p>
</section>
<section id="getting-the-data-type-of-the-expression">
<h2>Getting the data type of the expression<a class="headerlink" href="#getting-the-data-type-of-the-expression" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">arrow::datatypes::DataType</span></code> of the expression can be obtained by calling the <code class="docutils literal notranslate"><span class="pre">get_type</span></code> given something that implements <code class="docutils literal notranslate"><span class="pre">Expr::Schemable</span></code>, for example a <code class="docutils literal notranslate"><span class="pre">DFschema</span></code> object:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">arrow</span><span class="p">::</span><span class="n">datatypes</span><span class="p">::{</span><span class="n">DataType</span><span class="p">,</span><span class="w"> </span><span class="n">Field</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">common</span><span class="p">::</span><span class="n">DFSchema</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">logical_expr</span><span class="p">::{</span><span class="n">col</span><span class="p">,</span><span class="w"> </span><span class="n">ExprSchemable</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">collections</span><span class="p">::</span><span class="n">HashMap</span><span class="p">;</span>

<span class="c1">// Get the type of an expression that adds 2 columns. Adding an Int32</span>
<span class="c1">// and Float32 results in Float32 type</span>
<span class="kd">let</span><span class="w"> </span><span class="n">expr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">col</span><span class="p">(</span><span class="s">&quot;c1&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">col</span><span class="p">(</span><span class="s">&quot;c2&quot;</span><span class="p">);</span>
<span class="kd">let</span><span class="w"> </span><span class="n">schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DFSchema</span><span class="p">::</span><span class="n">from_unqualified_fields</span><span class="p">(</span>
<span class="w">    </span><span class="fm">vec!</span><span class="p">[</span>
<span class="w">        </span><span class="n">Field</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="s">&quot;c1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DataType</span><span class="p">::</span><span class="n">Int32</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">),</span>
<span class="w">        </span><span class="n">Field</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="s">&quot;c2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">DataType</span><span class="p">::</span><span class="n">Float32</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">),</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">    </span><span class="p">.</span><span class="n">into</span><span class="p">(),</span>
<span class="w">    </span><span class="n">HashMap</span><span class="p">::</span><span class="n">new</span><span class="p">(),</span>
<span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="fm">assert_eq!</span><span class="p">(</span><span class="s">&quot;Float32&quot;</span><span class="p">,</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">expr</span><span class="p">.</span><span class="n">get_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">schema</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()));</span>
</pre></div>
</div>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading">¶</a></h2>
<p>In this guide, we’ve seen how to create <code class="docutils literal notranslate"><span class="pre">Expr</span></code>s programmatically and how to rewrite them. This is useful for simplifying and optimizing <code class="docutils literal notranslate"><span class="pre">Expr</span></code>s. We’ve also seen how to test our rule to ensure it works properly.</p>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="using-the-sql-api.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Using the SQL API</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="using-the-dataframe-api.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Using the DataFrame API</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
    <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
  
<!-- Based on pydata_sphinx_theme/footer.html -->
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2019-2025, Apache Software Foundation.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 8.2.3.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p>Apache DataFusion, Apache, the Apache feather logo, and the Apache DataFusion project logo</p>
      <p>are either registered trademarks or trademarks of The Apache Software Foundation in the United States and other countries.</p>
    </div>
  </div>
</footer>


  </body>
</html>